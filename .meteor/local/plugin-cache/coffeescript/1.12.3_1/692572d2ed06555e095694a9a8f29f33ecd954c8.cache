{"source":"__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar JobQueue,\n    _clearInterval,\n    _setImmediate,\n    _setInterval,\n    concatReduce,\n    isBoolean,\n    isInteger,\n    methodCall,\n    optionsHelp,\n    reduceCallbacks,\n    splitLongArray,\n    slice = [].slice,\n    indexOf = [].indexOf || function (item) {\n  for (var i = 0, l = this.length; i < l; i++) {\n    if (i in this && this[i] === item) return i;\n  }\n\n  return -1;\n};\n\nmethodCall = function (root, method, params, cb, after) {\n  var apply, name, ref, ref1, ref2, ref3;\n\n  if (after == null) {\n    after = function (ret) {\n      return ret;\n    };\n  }\n\n  apply = (ref = (ref1 = Job._ddp_apply) != null ? ref1[(ref2 = root.root) != null ? ref2 : root] : void 0) != null ? ref : Job._ddp_apply;\n\n  if (typeof apply !== 'function') {\n    throw new Error(\"Job remote method call error, no valid invocation method found.\");\n  }\n\n  name = ((ref3 = root.root) != null ? ref3 : root) + \"_\" + method;\n\n  if (cb && typeof cb === 'function') {\n    return apply(name, params, function (_this) {\n      return function (err, res) {\n        if (err) {\n          return cb(err);\n        }\n\n        return cb(null, after(res));\n      };\n    }(this));\n  } else {\n    return after(apply(name, params));\n  }\n};\n\noptionsHelp = function (options, cb) {\n  var ref;\n\n  if (cb != null && typeof cb !== 'function') {\n    options = cb;\n    cb = void 0;\n  } else {\n    if (!((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) === 'object' && options instanceof Array && options.length < 2)) {\n      throw new Error('options... in optionsHelp must be an Array with zero or one elements');\n    }\n\n    options = (ref = options != null ? options[0] : void 0) != null ? ref : {};\n  }\n\n  if ((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) !== 'object') {\n    throw new Error('in optionsHelp options not an object or bad callback');\n  }\n\n  return [options, cb];\n};\n\nsplitLongArray = function (arr, max) {\n  var i, k, ref, results;\n\n  if (!(arr instanceof Array && max > 0)) {\n    throw new Error('splitLongArray: bad params');\n  }\n\n  results = [];\n\n  for (i = k = 0, ref = Math.ceil(arr.length / max); 0 <= ref ? k < ref : k > ref; i = 0 <= ref ? ++k : --k) {\n    results.push(arr.slice(i * max, (i + 1) * max));\n  }\n\n  return results;\n};\n\nreduceCallbacks = function (cb, num, reduce, init) {\n  var cbCount, cbErr, cbRetVal;\n\n  if (reduce == null) {\n    reduce = function (a, b) {\n      return a || b;\n    };\n  }\n\n  if (init == null) {\n    init = false;\n  }\n\n  if (cb == null) {\n    return void 0;\n  }\n\n  if (!(typeof cb === 'function' && num > 0 && typeof reduce === 'function')) {\n    throw new Error('Bad params given to reduceCallbacks');\n  }\n\n  cbRetVal = init;\n  cbCount = 0;\n  cbErr = null;\n  return function (err, res) {\n    if (!cbErr) {\n      if (err) {\n        cbErr = err;\n        return cb(err);\n      } else {\n        cbCount++;\n        cbRetVal = reduce(cbRetVal, res);\n\n        if (cbCount === num) {\n          return cb(null, cbRetVal);\n        } else if (cbCount > num) {\n          throw new Error(\"reduceCallbacks callback invoked more than requested \" + num + \" times\");\n        }\n      }\n    }\n  };\n};\n\nconcatReduce = function (a, b) {\n  if (!(a instanceof Array)) {\n    a = [a];\n  }\n\n  return a.concat(b);\n};\n\nisInteger = function (i) {\n  return typeof i === 'number' && Math.floor(i) === i;\n};\n\nisBoolean = function (b) {\n  return typeof b === 'boolean';\n};\n\n_setImmediate = function () {\n  var args, func;\n  func = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];\n\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setTimeout : void 0) != null) {\n    return Meteor.setTimeout.apply(Meteor, [func, 0].concat(slice.call(args)));\n  } else if (typeof setImmediate !== \"undefined\" && setImmediate !== null) {\n    return setImmediate.apply(null, [func].concat(slice.call(args)));\n  } else {\n    return setTimeout.apply(null, [func, 0].concat(slice.call(args)));\n  }\n};\n\n_setInterval = function () {\n  var args, func, timeOut;\n  func = arguments[0], timeOut = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];\n\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setInterval : void 0) != null) {\n    return Meteor.setInterval.apply(Meteor, [func, timeOut].concat(slice.call(args)));\n  } else {\n    return setInterval.apply(null, [func, timeOut].concat(slice.call(args)));\n  }\n};\n\n_clearInterval = function (id) {\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.clearInterval : void 0) != null) {\n    return Meteor.clearInterval(id);\n  } else {\n    return clearInterval(id);\n  }\n};\n\nJobQueue = function () {\n  function JobQueue() {\n    var k, options, ref, ref1, ref2, ref3, root1, type1, worker;\n    root1 = arguments[0], type1 = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), worker = arguments[k++];\n    this.root = root1;\n    this.type = type1;\n    this.worker = worker;\n\n    if (!(this instanceof JobQueue)) {\n      return function (func, args, ctor) {\n        ctor.prototype = func.prototype;\n        var child = new ctor(),\n            result = func.apply(child, args);\n        return Object(result) === result ? result : child;\n      }(JobQueue, [this.root, this.type].concat(slice.call(options), [this.worker]), function () {});\n    }\n\n    ref = optionsHelp(options, this.worker), options = ref[0], this.worker = ref[1];\n    this.pollInterval = options.pollInterval != null && !options.pollInterval ? Job.forever : !(options.pollInterval != null && isInteger(options.pollInterval)) ? 5000 : options.pollInterval;\n\n    if (!(isInteger(this.pollInterval) && this.pollInterval >= 0)) {\n      throw new Error(\"JobQueue: Invalid pollInterval, must be a positive integer\");\n    }\n\n    this.concurrency = (ref1 = options.concurrency) != null ? ref1 : 1;\n\n    if (!(isInteger(this.concurrency) && this.concurrency >= 0)) {\n      throw new Error(\"JobQueue: Invalid concurrency, must be a positive integer\");\n    }\n\n    this.payload = (ref2 = options.payload) != null ? ref2 : 1;\n\n    if (!(isInteger(this.payload) && this.payload >= 0)) {\n      throw new Error(\"JobQueue: Invalid payload, must be a positive integer\");\n    }\n\n    this.prefetch = (ref3 = options.prefetch) != null ? ref3 : 0;\n\n    if (!(isInteger(this.prefetch) && this.prefetch >= 0)) {\n      throw new Error(\"JobQueue: Invalid prefetch, must be a positive integer\");\n    }\n\n    this.workTimeout = options.workTimeout;\n\n    if (this.workTimeout != null && !(isInteger(this.workTimeout) && this.workTimeout >= 0)) {\n      throw new Error(\"JobQueue: Invalid workTimeout, must be a positive integer\");\n    }\n\n    this.callbackStrict = options.callbackStrict;\n\n    if (this.callbackStrict != null && !isBoolean(this.callbackStrict)) {\n      throw new Error(\"JobQueue: Invalid callbackStrict, must be a boolean\");\n    }\n\n    this._workers = {};\n    this._tasks = [];\n    this._taskNumber = 0;\n    this._stoppingGetWork = void 0;\n    this._stoppingTasks = void 0;\n    this._interval = null;\n    this._getWorkOutstanding = false;\n    this.paused = true;\n    this.resume();\n  }\n\n  JobQueue.prototype._getWork = function () {\n    var numJobsToGet, options;\n\n    if (!(this._getWorkOutstanding || this.paused)) {\n      numJobsToGet = this.prefetch + this.payload * (this.concurrency - this.running()) - this.length();\n\n      if (numJobsToGet > 0) {\n        this._getWorkOutstanding = true;\n        options = {\n          maxJobs: numJobsToGet\n        };\n\n        if (this.workTimeout != null) {\n          options.workTimeout = this.workTimeout;\n        }\n\n        return Job.getWork(this.root, this.type, options, function (_this) {\n          return function (err, jobs) {\n            var j, k, len;\n            _this._getWorkOutstanding = false;\n\n            if (err) {\n              return console.error(\"JobQueue: Received error from getWork(): \", err);\n            } else if (jobs != null && jobs instanceof Array) {\n              if (jobs.length > numJobsToGet) {\n                console.error(\"JobQueue: getWork() returned jobs (\" + jobs.length + \") in excess of maxJobs (\" + numJobsToGet + \")\");\n              }\n\n              for (k = 0, len = jobs.length; k < len; k++) {\n                j = jobs[k];\n\n                _this._tasks.push(j);\n\n                if (_this._stoppingGetWork == null) {\n                  _setImmediate(_this._process.bind(_this));\n                }\n              }\n\n              if (_this._stoppingGetWork != null) {\n                return _this._stoppingGetWork();\n              }\n            } else {\n              return console.error(\"JobQueue: Nonarray response from server from getWork()\");\n            }\n          };\n        }(this));\n      }\n    }\n  };\n\n  JobQueue.prototype._only_once = function (fn) {\n    var called;\n    called = false;\n    return function (_this) {\n      return function () {\n        if (called) {\n          console.error(\"Worker callback called multiple times in JobQueue\");\n\n          if (_this.callbackStrict) {\n            throw new Error(\"JobQueue worker callback was invoked multiple times\");\n          }\n        }\n\n        called = true;\n        return fn.apply(_this, arguments);\n      };\n    }(this);\n  };\n\n  JobQueue.prototype._process = function () {\n    var cb, job, next;\n\n    if (!this.paused && this.running() < this.concurrency && this.length()) {\n      if (this.payload > 1) {\n        job = this._tasks.splice(0, this.payload);\n      } else {\n        job = this._tasks.shift();\n      }\n\n      job._taskId = \"Task_\" + this._taskNumber++;\n      this._workers[job._taskId] = job;\n\n      next = function (_this) {\n        return function () {\n          delete _this._workers[job._taskId];\n\n          if (_this._stoppingTasks != null && _this.running() === 0 && _this.length() === 0) {\n            return _this._stoppingTasks();\n          } else {\n            _setImmediate(_this._process.bind(_this));\n\n            return _setImmediate(_this._getWork.bind(_this));\n          }\n        };\n      }(this);\n\n      cb = this._only_once(next);\n      return this.worker(job, cb);\n    }\n  };\n\n  JobQueue.prototype._stopGetWork = function (callback) {\n    _clearInterval(this._interval);\n\n    this._interval = null;\n\n    if (this._getWorkOutstanding) {\n      return this._stoppingGetWork = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._waitForTasks = function (callback) {\n    if (this.running() !== 0) {\n      return this._stoppingTasks = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._failJobs = function (tasks, callback) {\n    var count, job, k, len, results;\n\n    if (tasks.length === 0) {\n      _setImmediate(callback);\n    }\n\n    count = 0;\n    results = [];\n\n    for (k = 0, len = tasks.length; k < len; k++) {\n      job = tasks[k];\n      results.push(job.fail(\"Worker shutdown\", function (_this) {\n        return function (err, res) {\n          count++;\n\n          if (count === tasks.length) {\n            return callback();\n          }\n        };\n      }(this)));\n    }\n\n    return results;\n  };\n\n  JobQueue.prototype._hard = function (callback) {\n    this.paused = true;\n    return this._stopGetWork(function (_this) {\n      return function () {\n        var i, r, ref, tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        ref = _this._workers;\n\n        for (i in meteorBabelHelpers.sanitizeForInObject(ref)) {\n          r = ref[i];\n          tasks = tasks.concat(r);\n        }\n\n        return _this._failJobs(tasks, callback);\n      };\n    }(this));\n  };\n\n  JobQueue.prototype._stop = function (callback) {\n    this.paused = true;\n    return this._stopGetWork(function (_this) {\n      return function () {\n        var tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        return _this._waitForTasks(function () {\n          return _this._failJobs(tasks, callback);\n        });\n      };\n    }(this));\n  };\n\n  JobQueue.prototype._soft = function (callback) {\n    return this._stopGetWork(function (_this) {\n      return function () {\n        return _this._waitForTasks(callback);\n      };\n    }(this));\n  };\n\n  JobQueue.prototype.length = function () {\n    return this._tasks.length;\n  };\n\n  JobQueue.prototype.running = function () {\n    return Object.keys(this._workers).length;\n  };\n\n  JobQueue.prototype.idle = function () {\n    return this.length() + this.running() === 0;\n  };\n\n  JobQueue.prototype.full = function () {\n    return this.running() === this.concurrency;\n  };\n\n  JobQueue.prototype.pause = function () {\n    if (this.paused) {\n      return;\n    }\n\n    if (!(this.pollInterval >= Job.forever)) {\n      _clearInterval(this._interval);\n\n      this._interval = null;\n    }\n\n    this.paused = true;\n    return this;\n  };\n\n  JobQueue.prototype.resume = function () {\n    var k, ref, w;\n\n    if (!this.paused) {\n      return;\n    }\n\n    this.paused = false;\n\n    _setImmediate(this._getWork.bind(this));\n\n    if (!(this.pollInterval >= Job.forever)) {\n      this._interval = _setInterval(this._getWork.bind(this), this.pollInterval);\n    }\n\n    for (w = k = 1, ref = this.concurrency; 1 <= ref ? k <= ref : k >= ref; w = 1 <= ref ? ++k : --k) {\n      _setImmediate(this._process.bind(this));\n    }\n\n    return this;\n  };\n\n  JobQueue.prototype.trigger = function () {\n    if (this.paused) {\n      return;\n    }\n\n    _setImmediate(this._getWork.bind(this));\n\n    return this;\n  };\n\n  JobQueue.prototype.shutdown = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.level == null) {\n      options.level = 'normal';\n    }\n\n    if (options.quiet == null) {\n      options.quiet = false;\n    }\n\n    if (cb == null) {\n      if (!options.quiet) {\n        console.warn(\"using default shutdown callback!\");\n      }\n\n      cb = function (_this) {\n        return function () {\n          return console.warn(\"Shutdown complete\");\n        };\n      }(this);\n    }\n\n    switch (options.level) {\n      case 'hard':\n        if (!options.quiet) {\n          console.warn(\"Shutting down hard\");\n        }\n\n        return this._hard(cb);\n\n      case 'soft':\n        if (!options.quiet) {\n          console.warn(\"Shutting down soft\");\n        }\n\n        return this._soft(cb);\n\n      default:\n        if (!options.quiet) {\n          console.warn(\"Shutting down normally\");\n        }\n\n        return this._stop(cb);\n    }\n  };\n\n  return JobQueue;\n}();\n\nJob = function () {\n  Job.forever = 9007199254740992;\n  Job.foreverDate = new Date(8640000000000000);\n  Job.jobPriorities = {\n    low: 10,\n    normal: 0,\n    medium: -5,\n    high: -10,\n    critical: -15\n  };\n  Job.jobRetryBackoffMethods = ['constant', 'exponential'];\n  Job.jobStatuses = ['waiting', 'paused', 'ready', 'running', 'failed', 'cancelled', 'completed'];\n  Job.jobLogLevels = ['info', 'success', 'warning', 'danger'];\n  Job.jobStatusCancellable = ['running', 'ready', 'waiting', 'paused'];\n  Job.jobStatusPausable = ['ready', 'waiting'];\n  Job.jobStatusRemovable = ['cancelled', 'completed', 'failed'];\n  Job.jobStatusRestartable = ['cancelled', 'failed'];\n  Job.ddpMethods = ['startJobs', 'stopJobs', 'startJobServer', 'shutdownJobServer', 'jobRemove', 'jobPause', 'jobResume', 'jobReady', 'jobCancel', 'jobRestart', 'jobSave', 'jobRerun', 'getWork', 'getJob', 'jobLog', 'jobProgress', 'jobDone', 'jobFail'];\n  Job.ddpPermissionLevels = ['admin', 'manager', 'creator', 'worker'];\n  Job.ddpMethodPermissions = {\n    'startJobs': ['startJobs', 'admin'],\n    'stopJobs': ['stopJobs', 'admin'],\n    'startJobServer': ['startJobServer', 'admin'],\n    'shutdownJobServer': ['shutdownJobServer', 'admin'],\n    'jobRemove': ['jobRemove', 'admin', 'manager'],\n    'jobPause': ['jobPause', 'admin', 'manager'],\n    'jobResume': ['jobResume', 'admin', 'manager'],\n    'jobCancel': ['jobCancel', 'admin', 'manager'],\n    'jobReady': ['jobReady', 'admin', 'manager'],\n    'jobRestart': ['jobRestart', 'admin', 'manager'],\n    'jobSave': ['jobSave', 'admin', 'creator'],\n    'jobRerun': ['jobRerun', 'admin', 'creator'],\n    'getWork': ['getWork', 'admin', 'worker'],\n    'getJob': ['getJob', 'admin', 'worker'],\n    'jobLog': ['jobLog', 'admin', 'worker'],\n    'jobProgress': ['jobProgress', 'admin', 'worker'],\n    'jobDone': ['jobDone', 'admin', 'worker'],\n    'jobFail': ['jobFail', 'admin', 'worker']\n  };\n  Job._ddp_apply = void 0;\n\n  Job._setDDPApply = function (apply, collectionName) {\n    if (typeof apply === 'function') {\n      if (typeof collectionName === 'string') {\n        if (this._ddp_apply == null) {\n          this._ddp_apply = {};\n        }\n\n        if (typeof this._ddp_apply === 'function') {\n          throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n        }\n\n        return this._ddp_apply[collectionName] = apply;\n      } else if (!this._ddp_apply) {\n        return this._ddp_apply = apply;\n      } else {\n        throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n      }\n    } else {\n      throw new Error(\"Bad function in Job.setDDPApply()\");\n    }\n  };\n\n  Job.setDDP = function (ddp, collectionNames, Fiber) {\n    var collName, k, len, results;\n\n    if (ddp == null) {\n      ddp = null;\n    }\n\n    if (collectionNames == null) {\n      collectionNames = null;\n    }\n\n    if (Fiber == null) {\n      Fiber = null;\n    }\n\n    if (!(typeof collectionNames === 'string' || collectionNames instanceof Array)) {\n      Fiber = collectionNames;\n      collectionNames = [void 0];\n    } else if (typeof collectionNames === 'string') {\n      collectionNames = [collectionNames];\n    }\n\n    results = [];\n\n    for (k = 0, len = collectionNames.length; k < len; k++) {\n      collName = collectionNames[k];\n\n      if (!(ddp != null && ddp.close != null && ddp.subscribe != null)) {\n        if (ddp === null && (typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.apply : void 0) != null) {\n          results.push(this._setDDPApply(Meteor.apply, collName));\n        } else {\n          throw new Error(\"Bad ddp object in Job.setDDP()\");\n        }\n      } else if (ddp.observe == null) {\n        results.push(this._setDDPApply(ddp.apply.bind(ddp), collName));\n      } else {\n        if (Fiber == null) {\n          results.push(this._setDDPApply(ddp.call.bind(ddp), collName));\n        } else {\n          results.push(this._setDDPApply(function (name, params, cb) {\n            var fib;\n            fib = Fiber.current;\n            ddp.call(name, params, function (err, res) {\n              if (cb != null && typeof cb === 'function') {\n                return cb(err, res);\n              } else {\n                if (err) {\n                  return fib.throwInto(err);\n                } else {\n                  return fib.run(res);\n                }\n              }\n            });\n\n            if (cb != null && typeof cb === 'function') {} else {\n              return Fiber[\"yield\"]();\n            }\n          }, collName));\n        }\n      }\n    }\n\n    return results;\n  };\n\n  Job.getWork = function () {\n    var cb, k, options, ref, root, type;\n    root = arguments[0], type = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (typeof type === 'string') {\n      type = [type];\n    }\n\n    if (options.workTimeout != null) {\n      if (!(isInteger(options.workTimeout) && options.workTimeout > 0)) {\n        throw new Error('getWork: workTimeout must be a positive integer');\n      }\n    }\n\n    return methodCall(root, \"getWork\", [type, options], cb, function (_this) {\n      return function (res) {\n        var doc, jobs;\n\n        jobs = function () {\n          var l, len, results;\n          results = [];\n\n          for (l = 0, len = res.length; l < len; l++) {\n            doc = res[l];\n            results.push(new Job(root, doc));\n          }\n\n          return results;\n        }() || [];\n\n        if (options.maxJobs != null) {\n          return jobs;\n        } else {\n          return jobs[0];\n        }\n      };\n    }(this));\n  };\n\n  Job.processJobs = JobQueue;\n\n  Job.makeJob = function () {\n    var depFlag;\n    depFlag = false;\n    return function (root, doc) {\n      if (!depFlag) {\n        depFlag = true;\n        console.warn(\"Job.makeJob(root, jobDoc) has been deprecated and will be removed in a future release, use 'new Job(root, jobDoc)' instead.\");\n      }\n\n      return new Job(root, doc);\n    };\n  }();\n\n  Job.getJob = function () {\n    var cb, id, k, options, ref, root;\n    root = arguments[0], id = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n\n    return methodCall(root, \"getJob\", [id, options], cb, function (_this) {\n      return function (doc) {\n        if (doc) {\n          return new Job(root, doc);\n        } else {\n          return void 0;\n        }\n      };\n    }(this));\n  };\n\n  Job.getJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n\n    retVal = [];\n    chunksOfIds = splitLongArray(ids, 32);\n    myCb = reduceCallbacks(cb, chunksOfIds.length, concatReduce, []);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = retVal.concat(methodCall(root, \"getJob\", [chunkOfIds, options], myCb, function (_this) {\n        return function (doc) {\n          var d, len1, m, results;\n\n          if (doc) {\n            results = [];\n\n            for (m = 0, len1 = doc.length; m < len1; m++) {\n              d = doc[m];\n              results.push(new Job(root, d.type, d.data, d));\n            }\n\n            return results;\n          } else {\n            return null;\n          }\n        };\n      }(this)));\n    }\n\n    return retVal;\n  };\n\n  Job.pauseJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobPause\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.resumeJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobResume\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.readyJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n\n    if (ids == null) {\n      ids = [];\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.force == null) {\n      options.force = false;\n    }\n\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n\n    if (!(chunksOfIds.length > 0)) {\n      chunksOfIds = [[]];\n    }\n\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobReady\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.cancelJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobCancel\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.restartJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRestart\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.removeJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRemove\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.startJobs = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobs\", [options], cb);\n  };\n\n  Job.stopJobs = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n\n    return methodCall(root, \"stopJobs\", [options], cb);\n  };\n\n  Job.startJobServer = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobServer\", [options], cb);\n  };\n\n  Job.shutdownJobServer = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n\n    return methodCall(root, \"shutdownJobServer\", [options], cb);\n  };\n\n  function Job(root1, type, data) {\n    var doc, ref, time;\n    this.root = root1;\n\n    if (!(this instanceof Job)) {\n      return new Job(this.root, type, data);\n    }\n\n    this._root = this.root;\n\n    if (((ref = this.root) != null ? ref.root : void 0) != null && typeof this.root.root === 'string') {\n      this.root = this._root.root;\n    }\n\n    if (data == null && (type != null ? type.data : void 0) != null && (type != null ? type.type : void 0) != null) {\n      if (type instanceof Job) {\n        return type;\n      }\n\n      doc = type;\n      data = doc.data;\n      type = doc.type;\n    } else {\n      doc = {};\n    }\n\n    if (!((typeof doc === \"undefined\" ? \"undefined\" : _typeof(doc)) === 'object' && (typeof data === \"undefined\" ? \"undefined\" : _typeof(data)) === 'object' && typeof type === 'string' && typeof this.root === 'string')) {\n      throw new Error(\"new Job: bad parameter(s), \" + this.root + \" (\" + _typeof(this.root) + \"), \" + type + \" (\" + (typeof type === \"undefined\" ? \"undefined\" : _typeof(type)) + \"), \" + data + \" (\" + (typeof data === \"undefined\" ? \"undefined\" : _typeof(data)) + \"), \" + doc + \" (\" + (typeof doc === \"undefined\" ? \"undefined\" : _typeof(doc)) + \")\");\n    } else if (doc.type != null && doc.data != null) {\n      this._doc = doc;\n    } else {\n      time = new Date();\n      this._doc = {\n        runId: null,\n        type: type,\n        data: data,\n        status: 'waiting',\n        updated: time,\n        created: time\n      };\n      this.priority().retry().repeat().after().progress().depends().log(\"Constructed\");\n    }\n\n    return this;\n  }\n\n  Job.prototype._echo = function (message, level) {\n    if (level == null) {\n      level = null;\n    }\n\n    switch (level) {\n      case 'danger':\n        console.error(message);\n        break;\n\n      case 'warning':\n        console.warn(message);\n        break;\n\n      case 'success':\n        console.log(message);\n        break;\n\n      default:\n        console.info(message);\n    }\n  };\n\n  Job.prototype.depends = function (jobs) {\n    var depends, j, k, len;\n\n    if (jobs) {\n      if (jobs instanceof Job) {\n        jobs = [jobs];\n      }\n\n      if (jobs instanceof Array) {\n        depends = this._doc.depends;\n\n        for (k = 0, len = jobs.length; k < len; k++) {\n          j = jobs[k];\n\n          if (!(j instanceof Job && j._doc._id != null)) {\n            throw new Error('Each provided object must be a saved Job instance (with an _id)');\n          }\n\n          depends.push(j._doc._id);\n        }\n      } else {\n        throw new Error('Bad input parameter: depends() accepts a falsy value, or Job or array of Jobs');\n      }\n    } else {\n      depends = [];\n    }\n\n    this._doc.depends = depends;\n    this._doc.resolved = [];\n    return this;\n  };\n\n  Job.prototype.priority = function (level) {\n    var priority;\n\n    if (level == null) {\n      level = 0;\n    }\n\n    if (typeof level === 'string') {\n      priority = Job.jobPriorities[level];\n\n      if (priority == null) {\n        throw new Error('Invalid string priority level provided');\n      }\n    } else if (isInteger(level)) {\n      priority = level;\n    } else {\n      throw new Error('priority must be an integer or valid priority level');\n      priority = 0;\n    }\n\n    this._doc.priority = priority;\n    return this;\n  };\n\n  Job.prototype.retry = function (options) {\n    var base, ref;\n\n    if (options == null) {\n      options = 0;\n    }\n\n    if (isInteger(options) && options >= 0) {\n      options = {\n        retries: options\n      };\n    }\n\n    if ((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n\n    if (options.retries != null) {\n      if (!(isInteger(options.retries) && options.retries >= 0)) {\n        throw new Error('bad option: retries must be an integer >= 0');\n      }\n\n      options.retries++;\n    } else {\n      options.retries = Job.forever;\n    }\n\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n\n    if (options.backoff != null) {\n      if (ref = options.backoff, indexOf.call(Job.jobRetryBackoffMethods, ref) < 0) {\n        throw new Error('bad option: invalid retry backoff method');\n      }\n    } else {\n      options.backoff = 'constant';\n    }\n\n    this._doc.retries = options.retries;\n    this._doc.repeatRetries = options.retries;\n    this._doc.retryWait = options.wait;\n\n    if ((base = this._doc).retried == null) {\n      base.retried = 0;\n    }\n\n    this._doc.retryBackoff = options.backoff;\n    this._doc.retryUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.repeat = function (options) {\n    var base, ref;\n\n    if (options == null) {\n      options = 0;\n    }\n\n    if (isInteger(options) && options >= 0) {\n      options = {\n        repeats: options\n      };\n    }\n\n    if ((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n\n    if (options.wait != null && options.schedule != null) {\n      throw new Error('bad options: wait and schedule options are mutually exclusive');\n    }\n\n    if (options.repeats != null) {\n      if (!(isInteger(options.repeats) && options.repeats >= 0)) {\n        throw new Error('bad option: repeats must be an integer >= 0');\n      }\n    } else {\n      options.repeats = Job.forever;\n    }\n\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n\n    if (options.schedule != null) {\n      if (_typeof(options.schedule) !== 'object') {\n        throw new Error('bad option, schedule option must be an object');\n      }\n\n      if (!(((ref = options.schedule) != null ? ref.schedules : void 0) != null && options.schedule.schedules instanceof Array)) {\n        throw new Error('bad option, schedule object requires a schedules attribute of type Array.');\n      }\n\n      if (options.schedule.exceptions != null && !(options.schedule.exceptions instanceof Array)) {\n        throw new Error('bad option, schedule object exceptions attribute must be an Array');\n      }\n\n      options.wait = {\n        schedules: options.schedule.schedules,\n        exceptions: options.schedule.exceptions\n      };\n    }\n\n    this._doc.repeats = options.repeats;\n    this._doc.repeatWait = options.wait;\n\n    if ((base = this._doc).repeated == null) {\n      base.repeated = 0;\n    }\n\n    this._doc.repeatUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.delay = function (wait) {\n    if (wait == null) {\n      wait = 0;\n    }\n\n    if (!(isInteger(wait) && wait >= 0)) {\n      throw new Error('Bad parameter, delay requires a non-negative integer.');\n    }\n\n    return this.after(new Date(new Date().valueOf() + wait));\n  };\n\n  Job.prototype.after = function (time) {\n    var after;\n\n    if (time == null) {\n      time = new Date(0);\n    }\n\n    if ((typeof time === \"undefined\" ? \"undefined\" : _typeof(time)) === 'object' && time instanceof Date) {\n      after = time;\n    } else {\n      throw new Error('Bad parameter, after requires a valid Date object');\n    }\n\n    this._doc.after = after;\n    return this;\n  };\n\n  Job.prototype.log = function () {\n    var base, cb, k, message, options, ref, ref1;\n    message = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.level == null) {\n      options.level = 'info';\n    }\n\n    if (typeof message !== 'string') {\n      throw new Error('Log message must be a string');\n    }\n\n    if (!(typeof options.level === 'string' && (ref1 = options.level, indexOf.call(Job.jobLogLevels, ref1) >= 0))) {\n      throw new Error('Log level options must be one of Job.jobLogLevels');\n    }\n\n    if (options.echo != null) {\n      if (options.echo && Job.jobLogLevels.indexOf(options.level) >= Job.jobLogLevels.indexOf(options.echo)) {\n        this._echo(\"LOG: \" + options.level + \", \" + this._doc._id + \" \" + this._doc.runId + \": \" + message, options.level);\n      }\n\n      delete options.echo;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobLog\", [this._doc._id, this._doc.runId, message, options], cb);\n    } else {\n      if ((base = this._doc).log == null) {\n        base.log = [];\n      }\n\n      this._doc.log.push({\n        time: new Date(),\n        runId: null,\n        level: options.level,\n        message: message\n      });\n\n      if (cb != null && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n\n      return this;\n    }\n  };\n\n  Job.prototype.progress = function () {\n    var cb, completed, k, options, progress, ref, total;\n    completed = arguments[0], total = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n\n    if (completed == null) {\n      completed = 0;\n    }\n\n    if (total == null) {\n      total = 1;\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (typeof completed === 'number' && typeof total === 'number' && completed >= 0 && total > 0 && total >= completed) {\n      progress = {\n        completed: completed,\n        total: total,\n        percent: 100 * completed / total\n      };\n\n      if (options.echo) {\n        delete options.echo;\n\n        this._echo(\"PROGRESS: \" + this._doc._id + \" \" + this._doc.runId + \": \" + progress.completed + \" out of \" + progress.total + \" (\" + progress.percent + \"%)\");\n      }\n\n      if (this._doc._id != null && this._doc.runId != null) {\n        return methodCall(this._root, \"jobProgress\", [this._doc._id, this._doc.runId, completed, total, options], cb, function (_this) {\n          return function (res) {\n            if (res) {\n              _this._doc.progress = progress;\n            }\n\n            return res;\n          };\n        }(this));\n      } else if (this._doc._id == null) {\n        this._doc.progress = progress;\n\n        if (cb != null && typeof cb === 'function') {\n          _setImmediate(cb, null, true);\n        }\n\n        return this;\n      }\n    } else {\n      throw new Error(\"job.progress: something is wrong with progress params: \" + this.id + \", \" + completed + \" out of \" + total);\n    }\n\n    return null;\n  };\n\n  Job.prototype.save = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(this._root, \"jobSave\", [this._doc, options], cb, function (_this) {\n      return function (id) {\n        if (id) {\n          _this._doc._id = id;\n        }\n\n        return id;\n      };\n    }(this));\n  };\n\n  Job.prototype.refresh = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"getJob\", [this._doc._id, options], cb, function (_this) {\n        return function (doc) {\n          if (doc != null) {\n            _this._doc = doc;\n            return _this;\n          } else {\n            return false;\n          }\n        };\n      }(this));\n    } else {\n      throw new Error(\"Can't call .refresh() on an unsaved job\");\n    }\n  };\n\n  Job.prototype.done = function () {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n\n    if (result == null) {\n      result = {};\n    }\n\n    if (typeof result === 'function') {\n      cb = result;\n      result = {};\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (!(result != null && (typeof result === \"undefined\" ? \"undefined\" : _typeof(result)) === 'object')) {\n      result = {\n        value: result\n      };\n    }\n\n    if (this._doc._id != null && this._doc.runId != null) {\n      return methodCall(this._root, \"jobDone\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .done() on an unsaved or non-running job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.fail = function () {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n\n    if (result == null) {\n      result = \"No error information provided\";\n    }\n\n    if (typeof result === 'function') {\n      cb = result;\n      result = \"No error information provided\";\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (!(result != null && (typeof result === \"undefined\" ? \"undefined\" : _typeof(result)) === 'object')) {\n      result = {\n        value: result\n      };\n    }\n\n    if (options.fatal == null) {\n      options.fatal = false;\n    }\n\n    if (this._doc._id != null && this._doc.runId != null) {\n      return methodCall(this._root, \"jobFail\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .fail() on an unsaved or non-running job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.pause = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobPause\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'paused';\n\n      if (cb != null && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n\n      return this;\n    }\n\n    return null;\n  };\n\n  Job.prototype.resume = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobResume\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'waiting';\n\n      if (cb != null && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n\n      return this;\n    }\n\n    return null;\n  };\n\n  Job.prototype.ready = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.force == null) {\n      options.force = false;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobReady\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .ready() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.cancel = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobCancel\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .cancel() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.restart = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRestart\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .restart() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.rerun = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.repeats == null) {\n      options.repeats = 0;\n    }\n\n    if (options.wait == null) {\n      options.wait = this._doc.repeatWait;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRerun\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .rerun() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.remove = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRemove\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .remove() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Object.defineProperties(Job.prototype, {\n    doc: {\n      get: function () {\n        return this._doc;\n      },\n      set: function () {\n        return console.warn(\"Job.doc cannot be directly assigned.\");\n      }\n    },\n    type: {\n      get: function () {\n        return this._doc.type;\n      },\n      set: function () {\n        return console.warn(\"Job.type cannot be directly assigned.\");\n      }\n    },\n    data: {\n      get: function () {\n        return this._doc.data;\n      },\n      set: function () {\n        return console.warn(\"Job.data cannot be directly assigned.\");\n      }\n    }\n  });\n  return Job;\n}();\n\nif ((typeof module !== \"undefined\" && module !== null ? module.exports : void 0) != null) {\n  module.exports = Job;\n}","sourceMap":{"version":3,"sources":["/packages/vsivsi_job-collection/job/src/job_class.coffee","/job/src/job_class.coffee.js"],"names":["JobQueue","_clearInterval","_setImmediate","_setInterval","concatReduce","isBoolean","isInteger","methodCall","optionsHelp","reduceCallbacks","splitLongArray","slice","indexOf","item","i","l","length","root","method","params","cb","after","apply","name","ref","ref1","ref2","ref3","ret","Job","_ddp_apply","Error","_this","err","res","options","Array","arr","max","k","results","Math","ceil","push","num","reduce","init","cbCount","cbErr","cbRetVal","a","b","concat","floor","args","func","arguments","call","Meteor","setTimeout","setImmediate","timeOut","setInterval","id","clearInterval","root1","type1","worker","type","ctor","prototype","child","result","Object","pollInterval","forever","concurrency","payload","prefetch","workTimeout","callbackStrict","_workers","_tasks","_taskNumber","_stoppingGetWork","_stoppingTasks","_interval","_getWorkOutstanding","paused","resume","_getWork","numJobsToGet","running","maxJobs","getWork","jobs","j","len","console","error","_process","bind","_only_once","fn","called","job","next","splice","shift","_taskId","_stopGetWork","callback","_waitForTasks","_failJobs","tasks","count","fail","_hard","r","_stop","_soft","keys","idle","full","pause","w","trigger","shutdown","level","quiet","warn","foreverDate","Date","jobPriorities","low","normal","medium","high","critical","jobRetryBackoffMethods","jobStatuses","jobLogLevels","jobStatusCancellable","jobStatusPausable","jobStatusRemovable","jobStatusRestartable","ddpMethods","ddpPermissionLevels","ddpMethodPermissions","_setDDPApply","collectionName","setDDP","ddp","collectionNames","Fiber","collName","close","subscribe","observe","fib","current","throwInto","run","doc","processJobs","makeJob","depFlag","getJob","getLog","getJobs","chunkOfIds","chunksOfIds","ids","myCb","retVal","d","len1","m","data","pauseJobs","resumeJobs","readyJobs","force","cancelJobs","antecedents","restartJobs","retries","dependents","removeJobs","startJobs","stopJobs","timeout","startJobServer","shutdownJobServer","time","_root","_doc","runId","status","updated","created","priority","retry","repeat","progress","depends","log","_echo","message","info","_id","resolved","base","until","wait","backoff","repeatRetries","retryWait","retried","retryBackoff","retryUntil","repeats","schedule","schedules","exceptions","repeatWait","repeated","repeatUntil","delay","valueOf","echo","completed","total","percent","save","refresh","done","value","fatal","ready","cancel","restart","rerun","remove","defineProperties","get","set","module","exports"],"mappings":"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","file":"/packages/vsivsi:job-collection/job/src/job_class.coffee.map","sourcesContent":["############################################################################\n#     Copyright (C) 2014-2016 by Vaughn Iverson\n#     meteor-job-class is free software released under the MIT/X11 license.\n#     See included LICENSE file for details.\n############################################################################\n\n# Exports Job object\n\nmethodCall = (root, method, params, cb, after = ((ret) -> ret)) ->\n  apply = Job._ddp_apply?[root.root ? root] ? Job._ddp_apply\n  unless typeof apply is 'function'\n     throw new Error \"Job remote method call error, no valid invocation method found.\"\n  name = \"#{root.root ? root}_#{method}\"\n  if cb and typeof cb is 'function'\n    apply name, params, (err, res) =>\n      return cb err if err\n      cb null, after(res)\n  else\n    return after(apply name, params)\n\noptionsHelp = (options, cb) ->\n  # If cb isn't a function, it's assumed to be options...\n  if cb? and typeof cb isnt 'function'\n    options = cb\n    cb = undefined\n  else\n    unless (typeof options is 'object' and\n            options instanceof Array and\n            options.length < 2)\n      throw new Error 'options... in optionsHelp must be an Array with zero or one elements'\n    options = options?[0] ? {}\n  unless typeof options is 'object'\n    throw new Error 'in optionsHelp options not an object or bad callback'\n  return [options, cb]\n\nsplitLongArray = (arr, max) ->\n  throw new Error 'splitLongArray: bad params' unless arr instanceof Array and max > 0\n  arr[(i*max)...((i+1)*max)] for i in [0...Math.ceil(arr.length/max)]\n\n# This function soaks up num callbacks, by default returning the disjunction of Boolean results\n# or returning on first error.... Reduce function causes different reduce behavior, such as concatenation\nreduceCallbacks = (cb, num, reduce = ((a , b) -> (a or b)), init = false) ->\n  return undefined unless cb?\n  unless typeof cb is 'function' and num > 0 and typeof reduce is 'function'\n    throw new Error 'Bad params given to reduceCallbacks'\n  cbRetVal = init\n  cbCount = 0\n  cbErr = null\n  return (err, res) ->\n    unless cbErr\n      if err\n        cbErr = err\n        cb err\n      else\n        cbCount++\n        cbRetVal = reduce cbRetVal, res\n        if cbCount is num\n          cb null, cbRetVal\n        else if cbCount > num\n          throw new Error \"reduceCallbacks callback invoked more than requested #{num} times\"\n\nconcatReduce = (a, b) ->\n  a = [a] unless a instanceof Array\n  a.concat b\n\nisInteger = (i) -> typeof i is 'number' and Math.floor(i) is i\n\nisBoolean = (b) -> typeof b is 'boolean'\n\n# This smooths over the various different implementations...\n_setImmediate = (func, args...) ->\n  if Meteor?.setTimeout?\n    return Meteor.setTimeout func, 0, args...\n  else if setImmediate?\n    return setImmediate func, args...\n  else\n    # Browser fallback\n    return setTimeout func, 0, args...\n\n_setInterval = (func, timeOut, args...) ->\n  if Meteor?.setInterval?\n    return Meteor.setInterval func, timeOut, args...\n  else\n    # Browser / node.js fallback\n    return setInterval func, timeOut, args...\n\n_clearInterval = (id) ->\n  if Meteor?.clearInterval?\n    return Meteor.clearInterval id\n  else\n    # Browser / node.js fallback\n    return clearInterval id\n\n###################################################################\n\nclass JobQueue\n\n  constructor: (@root, @type, options..., @worker) ->\n    unless @ instanceof JobQueue\n      return new JobQueue @root, @type, options..., @worker\n    [options, @worker] = optionsHelp options, @worker\n\n    @pollInterval =\n      if options.pollInterval? and not options.pollInterval\n        Job.forever\n      else if not (options.pollInterval? and isInteger(options.pollInterval))\n        5000  # ms\n      else\n        options.pollInterval\n    unless isInteger(@pollInterval) and @pollInterval >= 0\n      throw new Error \"JobQueue: Invalid pollInterval, must be a positive integer\"\n\n    @concurrency = options.concurrency ? 1\n    unless isInteger(@concurrency) and @concurrency >= 0\n      throw new Error \"JobQueue: Invalid concurrency, must be a positive integer\"\n\n    @payload = options.payload ? 1\n    unless isInteger(@payload) and @payload >= 0\n      throw new Error \"JobQueue: Invalid payload, must be a positive integer\"\n\n    @prefetch = options.prefetch ? 0\n    unless isInteger(@prefetch) and @prefetch >= 0\n      throw new Error \"JobQueue: Invalid prefetch, must be a positive integer\"\n\n    @workTimeout = options.workTimeout  # No default\n    if @workTimeout? and not (isInteger(@workTimeout) and @workTimeout >= 0)\n      throw new Error \"JobQueue: Invalid workTimeout, must be a positive integer\"\n\n    @callbackStrict = options.callbackStrict\n    if @callbackStrict? and not isBoolean(@callbackStrict)\n      throw new Error \"JobQueue: Invalid callbackStrict, must be a boolean\"\n\n    @_workers = {}\n    @_tasks = []\n    @_taskNumber = 0\n    @_stoppingGetWork = undefined\n    @_stoppingTasks = undefined\n    @_interval = null\n    @_getWorkOutstanding = false\n    @paused = true\n    @resume()\n\n  _getWork: () ->\n    # Don't reenter, or run when paused or stopping\n    unless @_getWorkOutstanding or @paused\n      numJobsToGet = @prefetch + @payload*(@concurrency - @running()) - @length()\n      if numJobsToGet > 0\n        @_getWorkOutstanding = true\n        options = { maxJobs: numJobsToGet }\n        options.workTimeout = @workTimeout if @workTimeout?\n        Job.getWork @root, @type, options, (err, jobs) =>\n          @_getWorkOutstanding = false\n          if err\n            console.error \"JobQueue: Received error from getWork(): \", err\n          else if jobs? and jobs instanceof Array\n            if jobs.length > numJobsToGet\n              console.error \"JobQueue: getWork() returned jobs (#{jobs.length}) in excess of maxJobs (#{numJobsToGet})\"\n            for j in jobs\n              @_tasks.push j\n              _setImmediate @_process.bind(@) unless @_stoppingGetWork?\n            @_stoppingGetWork() if @_stoppingGetWork?\n          else\n            console.error \"JobQueue: Nonarray response from server from getWork()\"\n\n  _only_once: (fn) ->\n    called = false\n    return () =>\n      if called\n        console.error \"Worker callback called multiple times in JobQueue\"\n        if @callbackStrict\n          throw new Error \"JobQueue worker callback was invoked multiple times\"\n      called = true\n      fn.apply @, arguments\n\n  _process: () ->\n    if not @paused and @running() < @concurrency and @length()\n      if @payload > 1\n        job = @_tasks.splice 0, @payload\n      else\n        job = @_tasks.shift()\n      job._taskId = \"Task_#{@_taskNumber++}\"\n      @_workers[job._taskId] = job\n      next = () =>\n        delete @_workers[job._taskId]\n        if @_stoppingTasks? and @running() is 0 and @length() is 0\n          @_stoppingTasks()\n        else\n          _setImmediate @_process.bind(@)\n          _setImmediate @_getWork.bind(@)\n      cb = @_only_once next\n      @worker job, cb\n\n  _stopGetWork: (callback) ->\n    _clearInterval @_interval\n    @_interval = null\n    if @_getWorkOutstanding\n      @_stoppingGetWork = callback\n    else\n      _setImmediate callback  # No Zalgo, thanks\n\n  _waitForTasks: (callback) ->\n    unless @running() is 0\n      @_stoppingTasks = callback\n    else\n      _setImmediate callback  # No Zalgo, thanks\n\n  _failJobs: (tasks, callback) ->\n    _setImmediate callback if tasks.length is 0  # No Zalgo, thanks\n    count = 0\n    for job in tasks\n      job.fail \"Worker shutdown\", (err, res) =>\n        count++\n        if count is tasks.length\n          callback()\n\n  _hard: (callback) ->\n    @paused = true\n    @_stopGetWork () =>\n      tasks = @_tasks\n      @_tasks = []\n      for i, r of @_workers\n        tasks = tasks.concat r\n      @_failJobs tasks, callback\n\n  _stop: (callback) ->\n    @paused = true\n    @_stopGetWork () =>\n      tasks = @_tasks\n      @_tasks = []\n      @_waitForTasks () =>\n        @_failJobs tasks, callback\n\n  _soft: (callback) ->\n    @_stopGetWork () =>\n      @_waitForTasks callback\n\n  length: () -> @_tasks.length\n\n  running: () -> Object.keys(@_workers).length\n\n  idle: () -> @length() + @running() is 0\n\n  full: () -> @running() is @concurrency\n\n  pause: () ->\n    return if @paused\n    unless @pollInterval >= Job.forever\n      _clearInterval @_interval\n      @_interval = null\n    @paused = true\n    @\n\n  resume: () ->\n    return unless @paused\n    @paused = false\n    _setImmediate @_getWork.bind(@)\n    unless @pollInterval >= Job.forever\n      @_interval = _setInterval @_getWork.bind(@), @pollInterval\n    for w in [1..@concurrency]\n      _setImmediate @_process.bind(@)\n    @\n\n  trigger: () ->\n    return if @paused\n    _setImmediate @_getWork.bind(@)\n    @\n\n  shutdown: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.level ?= 'normal'\n    options.quiet ?= false\n    unless cb?\n      console.warn \"using default shutdown callback!\" unless options.quiet\n      cb = () =>\n        console.warn \"Shutdown complete\"\n    switch options.level\n      when 'hard'\n        console.warn \"Shutting down hard\" unless options.quiet\n        @_hard cb\n      when 'soft'\n        console.warn \"Shutting down soft\" unless options.quiet\n        @_soft cb\n      else\n        console.warn \"Shutting down normally\" unless options.quiet\n        @_stop cb\n\n###################################################################\n\nclass Job\n\n  # This is the JS max int value = 2^53\n  @forever = 9007199254740992\n\n  # This is the maximum date value in JS\n  @foreverDate = new Date 8640000000000000\n\n  @jobPriorities:\n    low: 10\n    normal: 0\n    medium: -5\n    high: -10\n    critical: -15\n\n  @jobRetryBackoffMethods: [ 'constant', 'exponential' ]\n\n  @jobStatuses: [ 'waiting', 'paused', 'ready', 'running'\n                  'failed', 'cancelled', 'completed' ]\n\n  @jobLogLevels: [ 'info', 'success', 'warning', 'danger' ]\n\n  @jobStatusCancellable: [ 'running', 'ready', 'waiting', 'paused' ]\n  @jobStatusPausable: [ 'ready', 'waiting' ]\n  @jobStatusRemovable:   [ 'cancelled', 'completed', 'failed' ]\n  @jobStatusRestartable: [ 'cancelled', 'failed' ]\n\n  @ddpMethods = [ 'startJobs', 'stopJobs',  # Deprecated!\n                  'startJobServer', 'shutdownJobServer',\n                  'jobRemove', 'jobPause', 'jobResume', 'jobReady'\n                  'jobCancel', 'jobRestart', 'jobSave', 'jobRerun', 'getWork'\n                  'getJob', 'jobLog', 'jobProgress', 'jobDone', 'jobFail' ]\n\n  @ddpPermissionLevels = [ 'admin', 'manager', 'creator', 'worker' ]\n\n  # These are the four levels of the allow/deny permission heirarchy\n  @ddpMethodPermissions =\n    'startJobs': ['startJobs', 'admin']  # Deprecated!\n    'stopJobs': ['stopJobs', 'admin']    # Deprecated!\n    'startJobServer': ['startJobServer', 'admin']\n    'shutdownJobServer': ['shutdownJobServer', 'admin']\n    'jobRemove': ['jobRemove', 'admin', 'manager']\n    'jobPause': ['jobPause', 'admin', 'manager']\n    'jobResume': ['jobResume', 'admin', 'manager']\n    'jobCancel': ['jobCancel', 'admin', 'manager']\n    'jobReady': ['jobReady', 'admin', 'manager']\n    'jobRestart': ['jobRestart', 'admin', 'manager']\n    'jobSave': ['jobSave', 'admin', 'creator']\n    'jobRerun': ['jobRerun', 'admin', 'creator']\n    'getWork': ['getWork', 'admin', 'worker']\n    'getJob': ['getJob', 'admin', 'worker']\n    'jobLog': [ 'jobLog', 'admin', 'worker']\n    'jobProgress': ['jobProgress', 'admin', 'worker']\n    'jobDone': ['jobDone', 'admin', 'worker']\n    'jobFail': ['jobFail', 'admin', 'worker']\n\n  # Automatically work within Meteor, otherwise see @setDDP below\n  @_ddp_apply: undefined\n\n  # Class methods\n\n  @_setDDPApply: (apply, collectionName) ->\n    if typeof apply is 'function'\n      if typeof collectionName is 'string'\n         @_ddp_apply ?= {}\n         if typeof @_ddp_apply is 'function'\n            throw new Error \"Job.setDDP must specify a collection name each time if called more than once.\"\n         @_ddp_apply[collectionName] = apply\n      else unless @_ddp_apply\n         @_ddp_apply = apply\n      else\n         throw new Error \"Job.setDDP must specify a collection name each time if called more than once.\"\n    else\n      throw new Error \"Bad function in Job.setDDPApply()\"\n\n  # This needs to be called when not running in Meteor to use the local DDP connection.\n  @setDDP: (ddp = null, collectionNames = null, Fiber = null) ->\n    unless (typeof collectionNames is 'string') or (collectionNames instanceof Array)\n      # Handle optional collection string with Fiber present\n      Fiber = collectionNames\n      collectionNames = [ undefined ]\n    else if typeof collectionNames is 'string'\n      # If string, convert to array of strings\n      collectionNames = [ collectionNames ]\n    for collName in collectionNames\n      unless ddp? and ddp.close? and ddp.subscribe?\n        # Not the DDP npm package\n        if ddp is null and Meteor?.apply?\n          # Meteor local server/client\n          @_setDDPApply Meteor.apply, collName\n        else\n          # No other possibilities...\n          throw new Error \"Bad ddp object in Job.setDDP()\"\n      else unless ddp.observe?  # This is a Meteor DDP connection object\n        @_setDDPApply ddp.apply.bind(ddp), collName\n      else # This is the npm DDP package\n        unless Fiber?\n          @_setDDPApply ddp.call.bind(ddp), collName\n        else\n          # If Fibers in use under pure node.js,\n          # make sure to yield and throw errors when no callback\n          @_setDDPApply(((name, params, cb) ->\n            fib = Fiber.current\n            ddp.call name, params, (err, res) ->\n              if cb? and typeof cb is 'function'\n                cb err, res\n              else\n                if err\n                  fib.throwInto err\n                else\n                  fib.run res\n            if cb? and typeof cb is 'function'\n              return\n            else\n              return Fiber.yield()\n          ), collName)\n\n  # Creates a job object by reserving the next available job of\n  # the specified 'type' from the server queue root\n  # returns null if no such job exists\n  @getWork: (root, type, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    type = [type] if typeof type is 'string'\n    if options.workTimeout?\n      unless isInteger(options.workTimeout) and options.workTimeout > 0\n        throw new Error 'getWork: workTimeout must be a positive integer'\n    methodCall root, \"getWork\", [type, options], cb, (res) =>\n      jobs = (new Job(root, doc) for doc in res) or []\n      if options.maxJobs?\n        return jobs\n      else\n        return jobs[0]\n\n  # This is defined above\n  @processJobs: JobQueue\n\n  # Makes a job object from a job document\n  # This method is deprecated and will be removed\n  @makeJob: do () ->\n    depFlag = false\n    (root, doc) ->\n      unless depFlag\n        depFlag = true\n        console.warn \"Job.makeJob(root, jobDoc) has been deprecated and will be removed in a future release, use 'new Job(root, jobDoc)' instead.\"\n      new Job root, doc\n\n  # Creates a job object by id from the server queue root\n  # returns null if no such job exists\n  @getJob: (root, id, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.getLog ?= false\n    methodCall root, \"getJob\", [id, options], cb, (doc) =>\n      if doc\n        new Job root, doc\n      else\n        undefined\n\n  # Like the above, but takes an array of ids, returns array of jobs\n  @getJobs: (root, ids, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.getLog ?= false\n    retVal = []\n    chunksOfIds = splitLongArray ids, 32\n    myCb = reduceCallbacks(cb, chunksOfIds.length, concatReduce, [])\n    for chunkOfIds in chunksOfIds\n      retVal = retVal.concat(methodCall root, \"getJob\", [chunkOfIds, options], myCb, (doc) =>\n        if doc\n          (new Job(root, d.type, d.data, d) for d in doc)\n        else\n          null)\n    return retVal\n\n  # Pause this job, only Ready and Waiting jobs can be paused\n  # Calling this toggles the paused state. Unpaused jobs go to waiting\n  @pauseJobs: (root, ids, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    retVal = false\n    chunksOfIds = splitLongArray ids, 256\n    myCb = reduceCallbacks(cb, chunksOfIds.length)\n    for chunkOfIds in chunksOfIds\n      retVal = methodCall(root, \"jobPause\", [chunkOfIds, options], myCb) || retVal\n    return retVal\n\n  # Resume this job, only Paused jobs can be resumed\n  # Calling this toggles the paused state. Unpaused jobs go to waiting\n  @resumeJobs: (root, ids, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    retVal = false\n    chunksOfIds = splitLongArray ids, 256\n    myCb = reduceCallbacks(cb, chunksOfIds.length)\n    for chunkOfIds in chunksOfIds\n      retVal = methodCall(root, \"jobResume\", [chunkOfIds, options], myCb) || retVal\n    return retVal\n\n  # Move waiting jobs to the ready state, jobs with dependencies will not\n  # be made ready unless force is used.\n  @readyJobs: (root, ids = [], options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.force ?= false\n    retVal = false\n    chunksOfIds = splitLongArray ids, 256\n    chunksOfIds = [[]] unless chunksOfIds.length > 0\n    myCb = reduceCallbacks(cb, chunksOfIds.length)\n    for chunkOfIds in chunksOfIds\n      retVal = methodCall(root, \"jobReady\", [chunkOfIds, options], myCb) || retVal\n    return retVal\n\n  # Cancel this job if it is running or able to run (waiting, ready)\n  @cancelJobs: (root, ids, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.antecedents ?= true\n    retVal = false\n    chunksOfIds = splitLongArray ids, 256\n    myCb = reduceCallbacks(cb, chunksOfIds.length)\n    for chunkOfIds in chunksOfIds\n      retVal = methodCall(root, \"jobCancel\", [chunkOfIds, options], myCb) || retVal\n    return retVal\n\n  # Restart a failed or cancelled job\n  @restartJobs: (root, ids, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.retries ?= 1\n    options.dependents ?= true\n    retVal = false\n    chunksOfIds = splitLongArray ids, 256\n    myCb = reduceCallbacks(cb, chunksOfIds.length)\n    for chunkOfIds in chunksOfIds\n      retVal = methodCall(root, \"jobRestart\", [chunkOfIds, options], myCb) || retVal\n    return retVal\n\n  # Remove a job that is not able to run (completed, cancelled, failed) from the queue\n  @removeJobs: (root, ids, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    retVal = false\n    chunksOfIds = splitLongArray ids, 256\n    myCb = reduceCallbacks(cb, chunksOfIds.length)\n    for chunkOfIds in chunksOfIds\n      retVal = methodCall(root, \"jobRemove\", [chunkOfIds, options], myCb) || retVal\n    return retVal\n\n  # Start the job queue\n  # Deprecated!\n  @startJobs: (root, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    methodCall root, \"startJobs\", [options], cb\n\n  # Stop the job queue, stop all running jobs\n  # Deprecated!\n  @stopJobs: (root, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.timeout ?= 60*1000\n    methodCall root, \"stopJobs\", [options], cb\n\n  # Start the job queue\n  @startJobServer: (root, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    methodCall root, \"startJobServer\", [options], cb\n\n  # Shutdown the job queue, stop all running jobs\n  @shutdownJobServer: (root, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.timeout ?= 60*1000\n    methodCall root, \"shutdownJobServer\", [options], cb\n\n  # Job class instance constructor. When \"new Job(...)\" is run\n  constructor: (@root, type, data) ->\n    unless @ instanceof Job\n      return new Job @root, type, data\n\n    # Keep the original root, whatever type that is\n    @_root = @root\n\n    # Handle root as object with obj.root attribute\n    if @root?.root? and typeof @root.root is 'string'\n      @root = @_root.root\n\n    # Handle (root, doc) signature\n    if not data? and type?.data? and type?.type?\n      if type instanceof Job\n        return type\n\n      doc = type\n      data = doc.data\n      type = doc.type\n    else\n      doc = {}\n\n    unless typeof doc is 'object' and\n           typeof data is 'object' and\n           typeof type is 'string' and\n           typeof @root is 'string'\n      throw new Error \"new Job: bad parameter(s), #{@root} (#{typeof @root}), #{type} (#{typeof type}), #{data} (#{typeof data}), #{doc} (#{typeof doc})\"\n\n    else if doc.type? and doc.data? # This case is used to create local Job objects from DDP calls\n      @_doc = doc\n\n    else  # This is the normal \"create a new object\" case\n      time = new Date()\n      @_doc =\n        runId: null\n        type : type\n        data: data\n        status: 'waiting'\n        updated: time\n        created: time\n      @priority().retry().repeat().after().progress().depends().log(\"Constructed\")\n\n    return @\n\n  # Override point for methods that have an echo option\n  _echo: (message, level = null) ->\n    switch level\n      when 'danger' then console.error message\n      when 'warning' then console.warn message\n      when 'success' then console.log message\n      else console.info message\n    return\n\n  # Adds a run dependancy on one or more existing jobs to this job\n  # Calling with a falsy value resets the dependencies to []\n  depends: (jobs) ->\n    if jobs\n      if jobs instanceof Job\n        jobs = [ jobs ]\n      if jobs instanceof Array\n        depends = @_doc.depends\n        for j in jobs\n          unless j instanceof Job and j._doc._id?\n            throw new Error 'Each provided object must be a saved Job instance (with an _id)'\n          depends.push j._doc._id\n      else\n        throw new Error 'Bad input parameter: depends() accepts a falsy value, or Job or array of Jobs'\n    else\n      depends = []\n    @_doc.depends = depends\n    @_doc.resolved = []  # This is where prior depends go as they are satisfied\n    return @\n\n  # Set the run priority of this job\n  priority: (level = 0) ->\n    if typeof level is 'string'\n      priority = Job.jobPriorities[level]\n      unless priority?\n        throw new Error 'Invalid string priority level provided'\n    else if isInteger(level)\n      priority = level\n    else\n      throw new Error 'priority must be an integer or valid priority level'\n      priority = 0\n    @_doc.priority = priority\n    return @\n\n  # Sets the number of attempted runs of this job and\n  # the time to wait between successive attempts\n  # Default, do not retry\n  retry: (options = 0) ->\n    if isInteger(options) and options >= 0\n      options = { retries: options }\n    if typeof options isnt 'object'\n      throw new Error 'bad parameter: accepts either an integer >= 0 or an options object'\n    if options.retries?\n      unless isInteger(options.retries) and options.retries >= 0\n        throw new Error 'bad option: retries must be an integer >= 0'\n      options.retries++\n    else\n      options.retries = Job.forever\n    if options.until?\n      unless options.until instanceof Date\n        throw new Error 'bad option: until must be a Date object'\n    else\n      options.until = Job.foreverDate\n    if options.wait?\n      unless isInteger(options.wait) and options.wait >= 0\n        throw new Error 'bad option: wait must be an integer >= 0'\n    else\n      options.wait = 5*60*1000\n    if options.backoff?\n      unless options.backoff in Job.jobRetryBackoffMethods\n        throw new Error 'bad option: invalid retry backoff method'\n    else\n      options.backoff = 'constant'\n\n    @_doc.retries = options.retries\n    @_doc.repeatRetries = options.retries\n    @_doc.retryWait = options.wait\n    @_doc.retried ?= 0\n    @_doc.retryBackoff = options.backoff\n    @_doc.retryUntil = options.until\n    return @\n\n  # Sets the number of times to repeatedly run this job\n  # and the time to wait between successive runs\n  # Default: repeat every 5 minutes, forever...\n  repeat: (options = 0) ->\n    if isInteger(options) and options >= 0\n      options = { repeats: options }\n    if typeof options isnt 'object'\n      throw new Error 'bad parameter: accepts either an integer >= 0 or an options object'\n    if options.wait? and options.schedule?\n      throw new Error 'bad options: wait and schedule options are mutually exclusive'\n    if options.repeats?\n      unless isInteger(options.repeats) and options.repeats >= 0\n        throw new Error 'bad option: repeats must be an integer >= 0'\n    else\n      options.repeats = Job.forever\n    if options.until?\n      unless options.until instanceof Date\n        throw new Error 'bad option: until must be a Date object'\n    else\n      options.until = Job.foreverDate\n    if options.wait?\n      unless isInteger(options.wait) and options.wait >= 0\n        throw new Error 'bad option: wait must be an integer >= 0'\n    else\n      options.wait = 5*60*1000\n    if options.schedule?\n      unless typeof options.schedule is 'object'\n        throw new Error 'bad option, schedule option must be an object'\n      unless options.schedule?.schedules? and options.schedule.schedules instanceof Array\n        throw new Error 'bad option, schedule object requires a schedules attribute of type Array.'\n      if options.schedule.exceptions? and not (options.schedule.exceptions instanceof Array)\n        throw new Error 'bad option, schedule object exceptions attribute must be an Array'\n      options.wait =\n        schedules: options.schedule.schedules\n        exceptions: options.schedule.exceptions\n\n    @_doc.repeats = options.repeats\n    @_doc.repeatWait = options.wait\n    @_doc.repeated ?= 0\n    @_doc.repeatUntil = options.until\n    return @\n\n  # Sets the delay before this job can run after it is saved\n  delay: (wait = 0) ->\n    unless isInteger(wait) and wait >= 0\n      throw new Error 'Bad parameter, delay requires a non-negative integer.'\n    return @after new Date(new Date().valueOf() + wait)\n\n  # Sets a time after which this job can run once it is saved\n  after: (time = new Date(0)) ->\n    if typeof time is 'object' and time instanceof Date\n      after = time\n    else\n      throw new Error 'Bad parameter, after requires a valid Date object'\n    @_doc.after = after\n    return @\n\n  # Write a message to this job's log.\n  log: (message, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.level ?= 'info'\n    unless typeof message is 'string'\n      throw new Error 'Log message must be a string'\n    unless typeof options.level is 'string' and options.level in Job.jobLogLevels\n      throw new Error 'Log level options must be one of Job.jobLogLevels'\n    if options.echo?\n      if options.echo and Job.jobLogLevels.indexOf(options.level) >= Job.jobLogLevels.indexOf(options.echo)\n        @_echo \"LOG: #{options.level}, #{@_doc._id} #{@_doc.runId}: #{message}\", options.level\n      delete options.echo\n    if @_doc._id?\n      return methodCall @_root, \"jobLog\", [@_doc._id, @_doc.runId, message, options], cb\n    else  # Log can be called on an unsaved job\n      @_doc.log ?= []\n      @_doc.log.push { time: new Date(), runId: null, level: options.level, message: message }\n      if cb? and typeof cb is 'function'\n        _setImmediate cb, null, true   # DO NOT release Zalgo\n      return @  # Allow call chaining in this case\n\n  # Indicate progress made for a running job. This is important for\n  # long running jobs so the scheduler doesn't assume they are dead\n  progress: (completed = 0, total = 1, options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    if (typeof completed is 'number' and\n        typeof total is 'number' and\n        completed >= 0 and\n        total > 0 and\n        total >= completed)\n      progress =\n        completed: completed\n        total: total\n        percent: 100*completed/total\n      if options.echo\n        delete options.echo\n        @_echo \"PROGRESS: #{@_doc._id} #{@_doc.runId}: #{progress.completed} out of #{progress.total} (#{progress.percent}%)\"\n      if @_doc._id? and @_doc.runId?\n        return methodCall @_root, \"jobProgress\", [@_doc._id, @_doc.runId, completed, total, options], cb, (res) =>\n          if res\n            @_doc.progress = progress\n          res\n      else unless @_doc._id?\n        @_doc.progress = progress\n        if cb? and typeof cb is 'function'\n          _setImmediate cb, null, true   # DO NOT release Zalgo\n        return @\n    else\n      throw new Error \"job.progress: something is wrong with progress params: #{@id}, #{completed} out of #{total}\"\n    return null\n\n  # Save this job to the server job queue Collection it will also resave a modified job if the\n  # job is not running and hasn't completed.\n  save: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    return methodCall @_root, \"jobSave\", [@_doc, options], cb, (id) =>\n      if id\n        @_doc._id = id\n      id\n\n  # Refresh the local job state with the server job queue's version\n  refresh: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.getLog ?= false\n    if @_doc._id?\n      return methodCall @_root, \"getJob\", [@_doc._id, options], cb, (doc) =>\n        if doc?\n          @_doc = doc\n          @\n        else\n          false\n    else\n      throw new Error \"Can't call .refresh() on an unsaved job\"\n\n  # Indicate to the server that this run has successfully finished.\n  done: (result = {}, options..., cb) ->\n    if typeof result is 'function'\n      cb = result\n      result = {}\n    [options, cb] = optionsHelp options, cb\n    unless result? and typeof result is 'object'\n      result = { value: result }\n    if @_doc._id? and @_doc.runId?\n      return methodCall @_root, \"jobDone\", [@_doc._id, @_doc.runId, result, options], cb\n    else\n      throw new Error \"Can't call .done() on an unsaved or non-running job\"\n    return null\n\n  # Indicate to the server that this run has failed and provide an error message.\n  fail: (result = \"No error information provided\", options..., cb) ->\n    if typeof result is 'function'\n      cb = result\n      result = \"No error information provided\"\n    [options, cb] = optionsHelp options, cb\n    unless result? and typeof result is 'object'\n      result = { value: result }\n    options.fatal ?= false\n    if @_doc._id? and @_doc.runId?\n      return methodCall @_root, \"jobFail\", [@_doc._id, @_doc.runId, result, options], cb\n    else\n      throw new Error \"Can't call .fail() on an unsaved or non-running job\"\n    return null\n\n  # Pause this job, only Ready and Waiting jobs can be paused\n  pause: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    if @_doc._id?\n      return methodCall @_root, \"jobPause\", [@_doc._id, options], cb\n    else\n      @_doc.status = 'paused'\n      if cb? and typeof cb is 'function'\n        _setImmediate cb, null, true  # DO NOT release Zalgo\n      return @\n    return null\n\n  # Resume this job, only Paused jobs can be resumed\n  # Resumed jobs go to waiting\n  resume: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    if @_doc._id?\n      return methodCall @_root, \"jobResume\", [@_doc._id, options], cb\n    else\n      @_doc.status = 'waiting'\n      if cb? and typeof cb is 'function'\n        _setImmediate cb, null, true  # DO NOT release Zalgo\n      return @\n    return null\n\n  # Make a waiting job ready to run. Jobs with dependencies only when forced\n  ready: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.force ?= false\n    if @_doc._id?\n      return methodCall @_root, \"jobReady\", [@_doc._id, options], cb\n    else\n      throw new Error \"Can't call .ready() on an unsaved job\"\n    return null\n\n  # Cancel this job if it is running or able to run (waiting, ready)\n  cancel: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.antecedents ?= true\n    if @_doc._id?\n      return methodCall @_root, \"jobCancel\", [@_doc._id, options], cb\n    else\n      throw new Error \"Can't call .cancel() on an unsaved job\"\n    return null\n\n  # Restart a failed or cancelled job\n  restart: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.retries ?= 1\n    options.dependents ?= true\n    if @_doc._id?\n      return methodCall @_root, \"jobRestart\", [@_doc._id, options], cb\n    else\n      throw new Error \"Can't call .restart() on an unsaved job\"\n    return null\n\n  # Run a completed job again as a new job, essentially a manual repeat\n  rerun: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    options.repeats ?= 0\n    options.wait ?= @_doc.repeatWait\n    if @_doc._id?\n      return methodCall @_root, \"jobRerun\", [@_doc._id, options], cb\n    else\n      throw new Error \"Can't call .rerun() on an unsaved job\"\n    return null\n\n  # Remove a job that is not able to run (completed, cancelled, failed) from the queue\n  remove: (options..., cb) ->\n    [options, cb] = optionsHelp options, cb\n    if @_doc._id?\n      return methodCall @_root, \"jobRemove\", [@_doc._id, options], cb\n    else\n      throw new Error \"Can't call .remove() on an unsaved job\"\n    return null\n\n    # Define convenience getters for some document properties\n  Object.defineProperties @prototype,\n    doc:\n      get: () -> @_doc\n      set: () -> console.warn \"Job.doc cannot be directly assigned.\"\n    type:\n      get: () -> @_doc.type\n      set: () -> console.warn \"Job.type cannot be directly assigned.\"\n    data:\n      get: () -> @_doc.data\n      set: () -> console.warn \"Job.data cannot be directly assigned.\"\n\n# Export Job in a npm package\nif module?.exports?\n  module.exports = Job\n","var JobQueue, _clearInterval, _setImmediate, _setInterval, concatReduce, isBoolean, isInteger, methodCall, optionsHelp, reduceCallbacks, splitLongArray,     \n  slice = [].slice,\n  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };\n\nmethodCall = function(root, method, params, cb, after) {\n  var apply, name, ref, ref1, ref2, ref3;\n  if (after == null) {\n    after = (function(ret) {\n      return ret;\n    });\n  }\n  apply = (ref = (ref1 = Job._ddp_apply) != null ? ref1[(ref2 = root.root) != null ? ref2 : root] : void 0) != null ? ref : Job._ddp_apply;\n  if (typeof apply !== 'function') {\n    throw new Error(\"Job remote method call error, no valid invocation method found.\");\n  }\n  name = ((ref3 = root.root) != null ? ref3 : root) + \"_\" + method;\n  if (cb && typeof cb === 'function') {\n    return apply(name, params, (function(_this) {\n      return function(err, res) {\n        if (err) {\n          return cb(err);\n        }\n        return cb(null, after(res));\n      };\n    })(this));\n  } else {\n    return after(apply(name, params));\n  }\n};\n\noptionsHelp = function(options, cb) {\n  var ref;\n  if ((cb != null) && typeof cb !== 'function') {\n    options = cb;\n    cb = void 0;\n  } else {\n    if (!(typeof options === 'object' && options instanceof Array && options.length < 2)) {\n      throw new Error('options... in optionsHelp must be an Array with zero or one elements');\n    }\n    options = (ref = options != null ? options[0] : void 0) != null ? ref : {};\n  }\n  if (typeof options !== 'object') {\n    throw new Error('in optionsHelp options not an object or bad callback');\n  }\n  return [options, cb];\n};\n\nsplitLongArray = function(arr, max) {\n  var i, k, ref, results;\n  if (!(arr instanceof Array && max > 0)) {\n    throw new Error('splitLongArray: bad params');\n  }\n  results = [];\n  for (i = k = 0, ref = Math.ceil(arr.length / max); 0 <= ref ? k < ref : k > ref; i = 0 <= ref ? ++k : --k) {\n    results.push(arr.slice(i * max, (i + 1) * max));\n  }\n  return results;\n};\n\nreduceCallbacks = function(cb, num, reduce, init) {\n  var cbCount, cbErr, cbRetVal;\n  if (reduce == null) {\n    reduce = (function(a, b) {\n      return a || b;\n    });\n  }\n  if (init == null) {\n    init = false;\n  }\n  if (cb == null) {\n    return void 0;\n  }\n  if (!(typeof cb === 'function' && num > 0 && typeof reduce === 'function')) {\n    throw new Error('Bad params given to reduceCallbacks');\n  }\n  cbRetVal = init;\n  cbCount = 0;\n  cbErr = null;\n  return function(err, res) {\n    if (!cbErr) {\n      if (err) {\n        cbErr = err;\n        return cb(err);\n      } else {\n        cbCount++;\n        cbRetVal = reduce(cbRetVal, res);\n        if (cbCount === num) {\n          return cb(null, cbRetVal);\n        } else if (cbCount > num) {\n          throw new Error(\"reduceCallbacks callback invoked more than requested \" + num + \" times\");\n        }\n      }\n    }\n  };\n};\n\nconcatReduce = function(a, b) {\n  if (!(a instanceof Array)) {\n    a = [a];\n  }\n  return a.concat(b);\n};\n\nisInteger = function(i) {\n  return typeof i === 'number' && Math.floor(i) === i;\n};\n\nisBoolean = function(b) {\n  return typeof b === 'boolean';\n};\n\n_setImmediate = function() {\n  var args, func;\n  func = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setTimeout : void 0) != null) {\n    return Meteor.setTimeout.apply(Meteor, [func, 0].concat(slice.call(args)));\n  } else if (typeof setImmediate !== \"undefined\" && setImmediate !== null) {\n    return setImmediate.apply(null, [func].concat(slice.call(args)));\n  } else {\n    return setTimeout.apply(null, [func, 0].concat(slice.call(args)));\n  }\n};\n\n_setInterval = function() {\n  var args, func, timeOut;\n  func = arguments[0], timeOut = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setInterval : void 0) != null) {\n    return Meteor.setInterval.apply(Meteor, [func, timeOut].concat(slice.call(args)));\n  } else {\n    return setInterval.apply(null, [func, timeOut].concat(slice.call(args)));\n  }\n};\n\n_clearInterval = function(id) {\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.clearInterval : void 0) != null) {\n    return Meteor.clearInterval(id);\n  } else {\n    return clearInterval(id);\n  }\n};\n\nJobQueue = (function() {\n  function JobQueue() {\n    var k, options, ref, ref1, ref2, ref3, root1, type1, worker;\n    root1 = arguments[0], type1 = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), worker = arguments[k++];\n    this.root = root1;\n    this.type = type1;\n    this.worker = worker;\n    if (!(this instanceof JobQueue)) {\n      return (function(func, args, ctor) {\n        ctor.prototype = func.prototype;\n        var child = new ctor, result = func.apply(child, args);\n        return Object(result) === result ? result : child;\n      })(JobQueue, [this.root, this.type].concat(slice.call(options), [this.worker]), function(){});\n    }\n    ref = optionsHelp(options, this.worker), options = ref[0], this.worker = ref[1];\n    this.pollInterval = (options.pollInterval != null) && !options.pollInterval ? Job.forever : !((options.pollInterval != null) && isInteger(options.pollInterval)) ? 5000 : options.pollInterval;\n    if (!(isInteger(this.pollInterval) && this.pollInterval >= 0)) {\n      throw new Error(\"JobQueue: Invalid pollInterval, must be a positive integer\");\n    }\n    this.concurrency = (ref1 = options.concurrency) != null ? ref1 : 1;\n    if (!(isInteger(this.concurrency) && this.concurrency >= 0)) {\n      throw new Error(\"JobQueue: Invalid concurrency, must be a positive integer\");\n    }\n    this.payload = (ref2 = options.payload) != null ? ref2 : 1;\n    if (!(isInteger(this.payload) && this.payload >= 0)) {\n      throw new Error(\"JobQueue: Invalid payload, must be a positive integer\");\n    }\n    this.prefetch = (ref3 = options.prefetch) != null ? ref3 : 0;\n    if (!(isInteger(this.prefetch) && this.prefetch >= 0)) {\n      throw new Error(\"JobQueue: Invalid prefetch, must be a positive integer\");\n    }\n    this.workTimeout = options.workTimeout;\n    if ((this.workTimeout != null) && !(isInteger(this.workTimeout) && this.workTimeout >= 0)) {\n      throw new Error(\"JobQueue: Invalid workTimeout, must be a positive integer\");\n    }\n    this.callbackStrict = options.callbackStrict;\n    if ((this.callbackStrict != null) && !isBoolean(this.callbackStrict)) {\n      throw new Error(\"JobQueue: Invalid callbackStrict, must be a boolean\");\n    }\n    this._workers = {};\n    this._tasks = [];\n    this._taskNumber = 0;\n    this._stoppingGetWork = void 0;\n    this._stoppingTasks = void 0;\n    this._interval = null;\n    this._getWorkOutstanding = false;\n    this.paused = true;\n    this.resume();\n  }\n\n  JobQueue.prototype._getWork = function() {\n    var numJobsToGet, options;\n    if (!(this._getWorkOutstanding || this.paused)) {\n      numJobsToGet = this.prefetch + this.payload * (this.concurrency - this.running()) - this.length();\n      if (numJobsToGet > 0) {\n        this._getWorkOutstanding = true;\n        options = {\n          maxJobs: numJobsToGet\n        };\n        if (this.workTimeout != null) {\n          options.workTimeout = this.workTimeout;\n        }\n        return Job.getWork(this.root, this.type, options, (function(_this) {\n          return function(err, jobs) {\n            var j, k, len;\n            _this._getWorkOutstanding = false;\n            if (err) {\n              return console.error(\"JobQueue: Received error from getWork(): \", err);\n            } else if ((jobs != null) && jobs instanceof Array) {\n              if (jobs.length > numJobsToGet) {\n                console.error(\"JobQueue: getWork() returned jobs (\" + jobs.length + \") in excess of maxJobs (\" + numJobsToGet + \")\");\n              }\n              for (k = 0, len = jobs.length; k < len; k++) {\n                j = jobs[k];\n                _this._tasks.push(j);\n                if (_this._stoppingGetWork == null) {\n                  _setImmediate(_this._process.bind(_this));\n                }\n              }\n              if (_this._stoppingGetWork != null) {\n                return _this._stoppingGetWork();\n              }\n            } else {\n              return console.error(\"JobQueue: Nonarray response from server from getWork()\");\n            }\n          };\n        })(this));\n      }\n    }\n  };\n\n  JobQueue.prototype._only_once = function(fn) {\n    var called;\n    called = false;\n    return (function(_this) {\n      return function() {\n        if (called) {\n          console.error(\"Worker callback called multiple times in JobQueue\");\n          if (_this.callbackStrict) {\n            throw new Error(\"JobQueue worker callback was invoked multiple times\");\n          }\n        }\n        called = true;\n        return fn.apply(_this, arguments);\n      };\n    })(this);\n  };\n\n  JobQueue.prototype._process = function() {\n    var cb, job, next;\n    if (!this.paused && this.running() < this.concurrency && this.length()) {\n      if (this.payload > 1) {\n        job = this._tasks.splice(0, this.payload);\n      } else {\n        job = this._tasks.shift();\n      }\n      job._taskId = \"Task_\" + (this._taskNumber++);\n      this._workers[job._taskId] = job;\n      next = (function(_this) {\n        return function() {\n          delete _this._workers[job._taskId];\n          if ((_this._stoppingTasks != null) && _this.running() === 0 && _this.length() === 0) {\n            return _this._stoppingTasks();\n          } else {\n            _setImmediate(_this._process.bind(_this));\n            return _setImmediate(_this._getWork.bind(_this));\n          }\n        };\n      })(this);\n      cb = this._only_once(next);\n      return this.worker(job, cb);\n    }\n  };\n\n  JobQueue.prototype._stopGetWork = function(callback) {\n    _clearInterval(this._interval);\n    this._interval = null;\n    if (this._getWorkOutstanding) {\n      return this._stoppingGetWork = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._waitForTasks = function(callback) {\n    if (this.running() !== 0) {\n      return this._stoppingTasks = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._failJobs = function(tasks, callback) {\n    var count, job, k, len, results;\n    if (tasks.length === 0) {\n      _setImmediate(callback);\n    }\n    count = 0;\n    results = [];\n    for (k = 0, len = tasks.length; k < len; k++) {\n      job = tasks[k];\n      results.push(job.fail(\"Worker shutdown\", (function(_this) {\n        return function(err, res) {\n          count++;\n          if (count === tasks.length) {\n            return callback();\n          }\n        };\n      })(this)));\n    }\n    return results;\n  };\n\n  JobQueue.prototype._hard = function(callback) {\n    this.paused = true;\n    return this._stopGetWork((function(_this) {\n      return function() {\n        var i, r, ref, tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        ref = _this._workers;\n        for (i in ref) {\n          r = ref[i];\n          tasks = tasks.concat(r);\n        }\n        return _this._failJobs(tasks, callback);\n      };\n    })(this));\n  };\n\n  JobQueue.prototype._stop = function(callback) {\n    this.paused = true;\n    return this._stopGetWork((function(_this) {\n      return function() {\n        var tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        return _this._waitForTasks(function() {\n          return _this._failJobs(tasks, callback);\n        });\n      };\n    })(this));\n  };\n\n  JobQueue.prototype._soft = function(callback) {\n    return this._stopGetWork((function(_this) {\n      return function() {\n        return _this._waitForTasks(callback);\n      };\n    })(this));\n  };\n\n  JobQueue.prototype.length = function() {\n    return this._tasks.length;\n  };\n\n  JobQueue.prototype.running = function() {\n    return Object.keys(this._workers).length;\n  };\n\n  JobQueue.prototype.idle = function() {\n    return this.length() + this.running() === 0;\n  };\n\n  JobQueue.prototype.full = function() {\n    return this.running() === this.concurrency;\n  };\n\n  JobQueue.prototype.pause = function() {\n    if (this.paused) {\n      return;\n    }\n    if (!(this.pollInterval >= Job.forever)) {\n      _clearInterval(this._interval);\n      this._interval = null;\n    }\n    this.paused = true;\n    return this;\n  };\n\n  JobQueue.prototype.resume = function() {\n    var k, ref, w;\n    if (!this.paused) {\n      return;\n    }\n    this.paused = false;\n    _setImmediate(this._getWork.bind(this));\n    if (!(this.pollInterval >= Job.forever)) {\n      this._interval = _setInterval(this._getWork.bind(this), this.pollInterval);\n    }\n    for (w = k = 1, ref = this.concurrency; 1 <= ref ? k <= ref : k >= ref; w = 1 <= ref ? ++k : --k) {\n      _setImmediate(this._process.bind(this));\n    }\n    return this;\n  };\n\n  JobQueue.prototype.trigger = function() {\n    if (this.paused) {\n      return;\n    }\n    _setImmediate(this._getWork.bind(this));\n    return this;\n  };\n\n  JobQueue.prototype.shutdown = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.level == null) {\n      options.level = 'normal';\n    }\n    if (options.quiet == null) {\n      options.quiet = false;\n    }\n    if (cb == null) {\n      if (!options.quiet) {\n        console.warn(\"using default shutdown callback!\");\n      }\n      cb = (function(_this) {\n        return function() {\n          return console.warn(\"Shutdown complete\");\n        };\n      })(this);\n    }\n    switch (options.level) {\n      case 'hard':\n        if (!options.quiet) {\n          console.warn(\"Shutting down hard\");\n        }\n        return this._hard(cb);\n      case 'soft':\n        if (!options.quiet) {\n          console.warn(\"Shutting down soft\");\n        }\n        return this._soft(cb);\n      default:\n        if (!options.quiet) {\n          console.warn(\"Shutting down normally\");\n        }\n        return this._stop(cb);\n    }\n  };\n\n  return JobQueue;\n\n})();\n\nJob = (function() {\n  Job.forever = 9007199254740992;\n\n  Job.foreverDate = new Date(8640000000000000);\n\n  Job.jobPriorities = {\n    low: 10,\n    normal: 0,\n    medium: -5,\n    high: -10,\n    critical: -15\n  };\n\n  Job.jobRetryBackoffMethods = ['constant', 'exponential'];\n\n  Job.jobStatuses = ['waiting', 'paused', 'ready', 'running', 'failed', 'cancelled', 'completed'];\n\n  Job.jobLogLevels = ['info', 'success', 'warning', 'danger'];\n\n  Job.jobStatusCancellable = ['running', 'ready', 'waiting', 'paused'];\n\n  Job.jobStatusPausable = ['ready', 'waiting'];\n\n  Job.jobStatusRemovable = ['cancelled', 'completed', 'failed'];\n\n  Job.jobStatusRestartable = ['cancelled', 'failed'];\n\n  Job.ddpMethods = ['startJobs', 'stopJobs', 'startJobServer', 'shutdownJobServer', 'jobRemove', 'jobPause', 'jobResume', 'jobReady', 'jobCancel', 'jobRestart', 'jobSave', 'jobRerun', 'getWork', 'getJob', 'jobLog', 'jobProgress', 'jobDone', 'jobFail'];\n\n  Job.ddpPermissionLevels = ['admin', 'manager', 'creator', 'worker'];\n\n  Job.ddpMethodPermissions = {\n    'startJobs': ['startJobs', 'admin'],\n    'stopJobs': ['stopJobs', 'admin'],\n    'startJobServer': ['startJobServer', 'admin'],\n    'shutdownJobServer': ['shutdownJobServer', 'admin'],\n    'jobRemove': ['jobRemove', 'admin', 'manager'],\n    'jobPause': ['jobPause', 'admin', 'manager'],\n    'jobResume': ['jobResume', 'admin', 'manager'],\n    'jobCancel': ['jobCancel', 'admin', 'manager'],\n    'jobReady': ['jobReady', 'admin', 'manager'],\n    'jobRestart': ['jobRestart', 'admin', 'manager'],\n    'jobSave': ['jobSave', 'admin', 'creator'],\n    'jobRerun': ['jobRerun', 'admin', 'creator'],\n    'getWork': ['getWork', 'admin', 'worker'],\n    'getJob': ['getJob', 'admin', 'worker'],\n    'jobLog': ['jobLog', 'admin', 'worker'],\n    'jobProgress': ['jobProgress', 'admin', 'worker'],\n    'jobDone': ['jobDone', 'admin', 'worker'],\n    'jobFail': ['jobFail', 'admin', 'worker']\n  };\n\n  Job._ddp_apply = void 0;\n\n  Job._setDDPApply = function(apply, collectionName) {\n    if (typeof apply === 'function') {\n      if (typeof collectionName === 'string') {\n        if (this._ddp_apply == null) {\n          this._ddp_apply = {};\n        }\n        if (typeof this._ddp_apply === 'function') {\n          throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n        }\n        return this._ddp_apply[collectionName] = apply;\n      } else if (!this._ddp_apply) {\n        return this._ddp_apply = apply;\n      } else {\n        throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n      }\n    } else {\n      throw new Error(\"Bad function in Job.setDDPApply()\");\n    }\n  };\n\n  Job.setDDP = function(ddp, collectionNames, Fiber) {\n    var collName, k, len, results;\n    if (ddp == null) {\n      ddp = null;\n    }\n    if (collectionNames == null) {\n      collectionNames = null;\n    }\n    if (Fiber == null) {\n      Fiber = null;\n    }\n    if (!((typeof collectionNames === 'string') || (collectionNames instanceof Array))) {\n      Fiber = collectionNames;\n      collectionNames = [void 0];\n    } else if (typeof collectionNames === 'string') {\n      collectionNames = [collectionNames];\n    }\n    results = [];\n    for (k = 0, len = collectionNames.length; k < len; k++) {\n      collName = collectionNames[k];\n      if (!((ddp != null) && (ddp.close != null) && (ddp.subscribe != null))) {\n        if (ddp === null && ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.apply : void 0) != null)) {\n          results.push(this._setDDPApply(Meteor.apply, collName));\n        } else {\n          throw new Error(\"Bad ddp object in Job.setDDP()\");\n        }\n      } else if (ddp.observe == null) {\n        results.push(this._setDDPApply(ddp.apply.bind(ddp), collName));\n      } else {\n        if (Fiber == null) {\n          results.push(this._setDDPApply(ddp.call.bind(ddp), collName));\n        } else {\n          results.push(this._setDDPApply((function(name, params, cb) {\n            var fib;\n            fib = Fiber.current;\n            ddp.call(name, params, function(err, res) {\n              if ((cb != null) && typeof cb === 'function') {\n                return cb(err, res);\n              } else {\n                if (err) {\n                  return fib.throwInto(err);\n                } else {\n                  return fib.run(res);\n                }\n              }\n            });\n            if ((cb != null) && typeof cb === 'function') {\n\n            } else {\n              return Fiber[\"yield\"]();\n            }\n          }), collName));\n        }\n      }\n    }\n    return results;\n  };\n\n  Job.getWork = function() {\n    var cb, k, options, ref, root, type;\n    root = arguments[0], type = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (typeof type === 'string') {\n      type = [type];\n    }\n    if (options.workTimeout != null) {\n      if (!(isInteger(options.workTimeout) && options.workTimeout > 0)) {\n        throw new Error('getWork: workTimeout must be a positive integer');\n      }\n    }\n    return methodCall(root, \"getWork\", [type, options], cb, (function(_this) {\n      return function(res) {\n        var doc, jobs;\n        jobs = ((function() {\n          var l, len, results;\n          results = [];\n          for (l = 0, len = res.length; l < len; l++) {\n            doc = res[l];\n            results.push(new Job(root, doc));\n          }\n          return results;\n        })()) || [];\n        if (options.maxJobs != null) {\n          return jobs;\n        } else {\n          return jobs[0];\n        }\n      };\n    })(this));\n  };\n\n  Job.processJobs = JobQueue;\n\n  Job.makeJob = (function() {\n    var depFlag;\n    depFlag = false;\n    return function(root, doc) {\n      if (!depFlag) {\n        depFlag = true;\n        console.warn(\"Job.makeJob(root, jobDoc) has been deprecated and will be removed in a future release, use 'new Job(root, jobDoc)' instead.\");\n      }\n      return new Job(root, doc);\n    };\n  })();\n\n  Job.getJob = function() {\n    var cb, id, k, options, ref, root;\n    root = arguments[0], id = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n    return methodCall(root, \"getJob\", [id, options], cb, (function(_this) {\n      return function(doc) {\n        if (doc) {\n          return new Job(root, doc);\n        } else {\n          return void 0;\n        }\n      };\n    })(this));\n  };\n\n  Job.getJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n    retVal = [];\n    chunksOfIds = splitLongArray(ids, 32);\n    myCb = reduceCallbacks(cb, chunksOfIds.length, concatReduce, []);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = retVal.concat(methodCall(root, \"getJob\", [chunkOfIds, options], myCb, (function(_this) {\n        return function(doc) {\n          var d, len1, m, results;\n          if (doc) {\n            results = [];\n            for (m = 0, len1 = doc.length; m < len1; m++) {\n              d = doc[m];\n              results.push(new Job(root, d.type, d.data, d));\n            }\n            return results;\n          } else {\n            return null;\n          }\n        };\n      })(this)));\n    }\n    return retVal;\n  };\n\n  Job.pauseJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobPause\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.resumeJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobResume\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.readyJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    if (ids == null) {\n      ids = [];\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.force == null) {\n      options.force = false;\n    }\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    if (!(chunksOfIds.length > 0)) {\n      chunksOfIds = [[]];\n    }\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobReady\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.cancelJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobCancel\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.restartJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRestart\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.removeJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRemove\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.startJobs = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobs\", [options], cb);\n  };\n\n  Job.stopJobs = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n    return methodCall(root, \"stopJobs\", [options], cb);\n  };\n\n  Job.startJobServer = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobServer\", [options], cb);\n  };\n\n  Job.shutdownJobServer = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n    return methodCall(root, \"shutdownJobServer\", [options], cb);\n  };\n\n  function Job(root1, type, data) {\n    var doc, ref, time;\n    this.root = root1;\n    if (!(this instanceof Job)) {\n      return new Job(this.root, type, data);\n    }\n    this._root = this.root;\n    if ((((ref = this.root) != null ? ref.root : void 0) != null) && typeof this.root.root === 'string') {\n      this.root = this._root.root;\n    }\n    if ((data == null) && ((type != null ? type.data : void 0) != null) && ((type != null ? type.type : void 0) != null)) {\n      if (type instanceof Job) {\n        return type;\n      }\n      doc = type;\n      data = doc.data;\n      type = doc.type;\n    } else {\n      doc = {};\n    }\n    if (!(typeof doc === 'object' && typeof data === 'object' && typeof type === 'string' && typeof this.root === 'string')) {\n      throw new Error(\"new Job: bad parameter(s), \" + this.root + \" (\" + (typeof this.root) + \"), \" + type + \" (\" + (typeof type) + \"), \" + data + \" (\" + (typeof data) + \"), \" + doc + \" (\" + (typeof doc) + \")\");\n    } else if ((doc.type != null) && (doc.data != null)) {\n      this._doc = doc;\n    } else {\n      time = new Date();\n      this._doc = {\n        runId: null,\n        type: type,\n        data: data,\n        status: 'waiting',\n        updated: time,\n        created: time\n      };\n      this.priority().retry().repeat().after().progress().depends().log(\"Constructed\");\n    }\n    return this;\n  }\n\n  Job.prototype._echo = function(message, level) {\n    if (level == null) {\n      level = null;\n    }\n    switch (level) {\n      case 'danger':\n        console.error(message);\n        break;\n      case 'warning':\n        console.warn(message);\n        break;\n      case 'success':\n        console.log(message);\n        break;\n      default:\n        console.info(message);\n    }\n  };\n\n  Job.prototype.depends = function(jobs) {\n    var depends, j, k, len;\n    if (jobs) {\n      if (jobs instanceof Job) {\n        jobs = [jobs];\n      }\n      if (jobs instanceof Array) {\n        depends = this._doc.depends;\n        for (k = 0, len = jobs.length; k < len; k++) {\n          j = jobs[k];\n          if (!(j instanceof Job && (j._doc._id != null))) {\n            throw new Error('Each provided object must be a saved Job instance (with an _id)');\n          }\n          depends.push(j._doc._id);\n        }\n      } else {\n        throw new Error('Bad input parameter: depends() accepts a falsy value, or Job or array of Jobs');\n      }\n    } else {\n      depends = [];\n    }\n    this._doc.depends = depends;\n    this._doc.resolved = [];\n    return this;\n  };\n\n  Job.prototype.priority = function(level) {\n    var priority;\n    if (level == null) {\n      level = 0;\n    }\n    if (typeof level === 'string') {\n      priority = Job.jobPriorities[level];\n      if (priority == null) {\n        throw new Error('Invalid string priority level provided');\n      }\n    } else if (isInteger(level)) {\n      priority = level;\n    } else {\n      throw new Error('priority must be an integer or valid priority level');\n      priority = 0;\n    }\n    this._doc.priority = priority;\n    return this;\n  };\n\n  Job.prototype.retry = function(options) {\n    var base, ref;\n    if (options == null) {\n      options = 0;\n    }\n    if (isInteger(options) && options >= 0) {\n      options = {\n        retries: options\n      };\n    }\n    if (typeof options !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n    if (options.retries != null) {\n      if (!(isInteger(options.retries) && options.retries >= 0)) {\n        throw new Error('bad option: retries must be an integer >= 0');\n      }\n      options.retries++;\n    } else {\n      options.retries = Job.forever;\n    }\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n    if (options.backoff != null) {\n      if (ref = options.backoff, indexOf.call(Job.jobRetryBackoffMethods, ref) < 0) {\n        throw new Error('bad option: invalid retry backoff method');\n      }\n    } else {\n      options.backoff = 'constant';\n    }\n    this._doc.retries = options.retries;\n    this._doc.repeatRetries = options.retries;\n    this._doc.retryWait = options.wait;\n    if ((base = this._doc).retried == null) {\n      base.retried = 0;\n    }\n    this._doc.retryBackoff = options.backoff;\n    this._doc.retryUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.repeat = function(options) {\n    var base, ref;\n    if (options == null) {\n      options = 0;\n    }\n    if (isInteger(options) && options >= 0) {\n      options = {\n        repeats: options\n      };\n    }\n    if (typeof options !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n    if ((options.wait != null) && (options.schedule != null)) {\n      throw new Error('bad options: wait and schedule options are mutually exclusive');\n    }\n    if (options.repeats != null) {\n      if (!(isInteger(options.repeats) && options.repeats >= 0)) {\n        throw new Error('bad option: repeats must be an integer >= 0');\n      }\n    } else {\n      options.repeats = Job.forever;\n    }\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n    if (options.schedule != null) {\n      if (typeof options.schedule !== 'object') {\n        throw new Error('bad option, schedule option must be an object');\n      }\n      if (!((((ref = options.schedule) != null ? ref.schedules : void 0) != null) && options.schedule.schedules instanceof Array)) {\n        throw new Error('bad option, schedule object requires a schedules attribute of type Array.');\n      }\n      if ((options.schedule.exceptions != null) && !(options.schedule.exceptions instanceof Array)) {\n        throw new Error('bad option, schedule object exceptions attribute must be an Array');\n      }\n      options.wait = {\n        schedules: options.schedule.schedules,\n        exceptions: options.schedule.exceptions\n      };\n    }\n    this._doc.repeats = options.repeats;\n    this._doc.repeatWait = options.wait;\n    if ((base = this._doc).repeated == null) {\n      base.repeated = 0;\n    }\n    this._doc.repeatUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.delay = function(wait) {\n    if (wait == null) {\n      wait = 0;\n    }\n    if (!(isInteger(wait) && wait >= 0)) {\n      throw new Error('Bad parameter, delay requires a non-negative integer.');\n    }\n    return this.after(new Date(new Date().valueOf() + wait));\n  };\n\n  Job.prototype.after = function(time) {\n    var after;\n    if (time == null) {\n      time = new Date(0);\n    }\n    if (typeof time === 'object' && time instanceof Date) {\n      after = time;\n    } else {\n      throw new Error('Bad parameter, after requires a valid Date object');\n    }\n    this._doc.after = after;\n    return this;\n  };\n\n  Job.prototype.log = function() {\n    var base, cb, k, message, options, ref, ref1;\n    message = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.level == null) {\n      options.level = 'info';\n    }\n    if (typeof message !== 'string') {\n      throw new Error('Log message must be a string');\n    }\n    if (!(typeof options.level === 'string' && (ref1 = options.level, indexOf.call(Job.jobLogLevels, ref1) >= 0))) {\n      throw new Error('Log level options must be one of Job.jobLogLevels');\n    }\n    if (options.echo != null) {\n      if (options.echo && Job.jobLogLevels.indexOf(options.level) >= Job.jobLogLevels.indexOf(options.echo)) {\n        this._echo(\"LOG: \" + options.level + \", \" + this._doc._id + \" \" + this._doc.runId + \": \" + message, options.level);\n      }\n      delete options.echo;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobLog\", [this._doc._id, this._doc.runId, message, options], cb);\n    } else {\n      if ((base = this._doc).log == null) {\n        base.log = [];\n      }\n      this._doc.log.push({\n        time: new Date(),\n        runId: null,\n        level: options.level,\n        message: message\n      });\n      if ((cb != null) && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n      return this;\n    }\n  };\n\n  Job.prototype.progress = function() {\n    var cb, completed, k, options, progress, ref, total;\n    completed = arguments[0], total = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    if (completed == null) {\n      completed = 0;\n    }\n    if (total == null) {\n      total = 1;\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (typeof completed === 'number' && typeof total === 'number' && completed >= 0 && total > 0 && total >= completed) {\n      progress = {\n        completed: completed,\n        total: total,\n        percent: 100 * completed / total\n      };\n      if (options.echo) {\n        delete options.echo;\n        this._echo(\"PROGRESS: \" + this._doc._id + \" \" + this._doc.runId + \": \" + progress.completed + \" out of \" + progress.total + \" (\" + progress.percent + \"%)\");\n      }\n      if ((this._doc._id != null) && (this._doc.runId != null)) {\n        return methodCall(this._root, \"jobProgress\", [this._doc._id, this._doc.runId, completed, total, options], cb, (function(_this) {\n          return function(res) {\n            if (res) {\n              _this._doc.progress = progress;\n            }\n            return res;\n          };\n        })(this));\n      } else if (this._doc._id == null) {\n        this._doc.progress = progress;\n        if ((cb != null) && typeof cb === 'function') {\n          _setImmediate(cb, null, true);\n        }\n        return this;\n      }\n    } else {\n      throw new Error(\"job.progress: something is wrong with progress params: \" + this.id + \", \" + completed + \" out of \" + total);\n    }\n    return null;\n  };\n\n  Job.prototype.save = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(this._root, \"jobSave\", [this._doc, options], cb, (function(_this) {\n      return function(id) {\n        if (id) {\n          _this._doc._id = id;\n        }\n        return id;\n      };\n    })(this));\n  };\n\n  Job.prototype.refresh = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"getJob\", [this._doc._id, options], cb, (function(_this) {\n        return function(doc) {\n          if (doc != null) {\n            _this._doc = doc;\n            return _this;\n          } else {\n            return false;\n          }\n        };\n      })(this));\n    } else {\n      throw new Error(\"Can't call .refresh() on an unsaved job\");\n    }\n  };\n\n  Job.prototype.done = function() {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    if (result == null) {\n      result = {};\n    }\n    if (typeof result === 'function') {\n      cb = result;\n      result = {};\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (!((result != null) && typeof result === 'object')) {\n      result = {\n        value: result\n      };\n    }\n    if ((this._doc._id != null) && (this._doc.runId != null)) {\n      return methodCall(this._root, \"jobDone\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .done() on an unsaved or non-running job\");\n    }\n    return null;\n  };\n\n  Job.prototype.fail = function() {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    if (result == null) {\n      result = \"No error information provided\";\n    }\n    if (typeof result === 'function') {\n      cb = result;\n      result = \"No error information provided\";\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (!((result != null) && typeof result === 'object')) {\n      result = {\n        value: result\n      };\n    }\n    if (options.fatal == null) {\n      options.fatal = false;\n    }\n    if ((this._doc._id != null) && (this._doc.runId != null)) {\n      return methodCall(this._root, \"jobFail\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .fail() on an unsaved or non-running job\");\n    }\n    return null;\n  };\n\n  Job.prototype.pause = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobPause\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'paused';\n      if ((cb != null) && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n      return this;\n    }\n    return null;\n  };\n\n  Job.prototype.resume = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobResume\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'waiting';\n      if ((cb != null) && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n      return this;\n    }\n    return null;\n  };\n\n  Job.prototype.ready = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.force == null) {\n      options.force = false;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobReady\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .ready() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.cancel = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobCancel\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .cancel() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.restart = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRestart\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .restart() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.rerun = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.repeats == null) {\n      options.repeats = 0;\n    }\n    if (options.wait == null) {\n      options.wait = this._doc.repeatWait;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRerun\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .rerun() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.remove = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRemove\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .remove() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Object.defineProperties(Job.prototype, {\n    doc: {\n      get: function() {\n        return this._doc;\n      },\n      set: function() {\n        return console.warn(\"Job.doc cannot be directly assigned.\");\n      }\n    },\n    type: {\n      get: function() {\n        return this._doc.type;\n      },\n      set: function() {\n        return console.warn(\"Job.type cannot be directly assigned.\");\n      }\n    },\n    data: {\n      get: function() {\n        return this._doc.data;\n      },\n      set: function() {\n        return console.warn(\"Job.data cannot be directly assigned.\");\n      }\n    }\n  });\n\n  return Job;\n\n})();\n\nif ((typeof module !== \"undefined\" && module !== null ? module.exports : void 0) != null) {\n  module.exports = Job;\n}\n"]}}