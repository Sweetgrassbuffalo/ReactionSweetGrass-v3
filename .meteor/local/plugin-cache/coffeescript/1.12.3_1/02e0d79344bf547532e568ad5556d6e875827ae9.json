{"metadata":{"usedHelpers":["typeof"],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/vsivsi:job-collection/job/src/job_class.coffee","filenameRelative":"/packages/vsivsi:job-collection/job/src/job_class.coffee","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/vsivsi:job-collection/job/src/job_class.coffee.map","sourceFileName":"/packages/vsivsi:job-collection/job/src/job_class.coffee","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"job_class"},"ignored":false,"code":"var _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar JobQueue,\n    _clearInterval,\n    _setImmediate,\n    _setInterval,\n    concatReduce,\n    isBoolean,\n    isInteger,\n    methodCall,\n    optionsHelp,\n    reduceCallbacks,\n    splitLongArray,\n    slice = [].slice,\n    indexOf = [].indexOf || function (item) {\n  for (var i = 0, l = this.length; i < l; i++) {\n    if (i in this && this[i] === item) return i;\n  }\n\n  return -1;\n};\n\nmethodCall = function (root, method, params, cb, after) {\n  var apply, name, ref, ref1, ref2, ref3;\n\n  if (after == null) {\n    after = function (ret) {\n      return ret;\n    };\n  }\n\n  apply = (ref = (ref1 = Job._ddp_apply) != null ? ref1[(ref2 = root.root) != null ? ref2 : root] : void 0) != null ? ref : Job._ddp_apply;\n\n  if (typeof apply !== 'function') {\n    throw new Error(\"Job remote method call error, no valid invocation method found.\");\n  }\n\n  name = ((ref3 = root.root) != null ? ref3 : root) + \"_\" + method;\n\n  if (cb && typeof cb === 'function') {\n    return apply(name, params, function (_this) {\n      return function (err, res) {\n        if (err) {\n          return cb(err);\n        }\n\n        return cb(null, after(res));\n      };\n    }(this));\n  } else {\n    return after(apply(name, params));\n  }\n};\n\noptionsHelp = function (options, cb) {\n  var ref;\n\n  if (cb != null && typeof cb !== 'function') {\n    options = cb;\n    cb = void 0;\n  } else {\n    if (!((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) === 'object' && options instanceof Array && options.length < 2)) {\n      throw new Error('options... in optionsHelp must be an Array with zero or one elements');\n    }\n\n    options = (ref = options != null ? options[0] : void 0) != null ? ref : {};\n  }\n\n  if ((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) !== 'object') {\n    throw new Error('in optionsHelp options not an object or bad callback');\n  }\n\n  return [options, cb];\n};\n\nsplitLongArray = function (arr, max) {\n  var i, k, ref, results;\n\n  if (!(arr instanceof Array && max > 0)) {\n    throw new Error('splitLongArray: bad params');\n  }\n\n  results = [];\n\n  for (i = k = 0, ref = Math.ceil(arr.length / max); 0 <= ref ? k < ref : k > ref; i = 0 <= ref ? ++k : --k) {\n    results.push(arr.slice(i * max, (i + 1) * max));\n  }\n\n  return results;\n};\n\nreduceCallbacks = function (cb, num, reduce, init) {\n  var cbCount, cbErr, cbRetVal;\n\n  if (reduce == null) {\n    reduce = function (a, b) {\n      return a || b;\n    };\n  }\n\n  if (init == null) {\n    init = false;\n  }\n\n  if (cb == null) {\n    return void 0;\n  }\n\n  if (!(typeof cb === 'function' && num > 0 && typeof reduce === 'function')) {\n    throw new Error('Bad params given to reduceCallbacks');\n  }\n\n  cbRetVal = init;\n  cbCount = 0;\n  cbErr = null;\n  return function (err, res) {\n    if (!cbErr) {\n      if (err) {\n        cbErr = err;\n        return cb(err);\n      } else {\n        cbCount++;\n        cbRetVal = reduce(cbRetVal, res);\n\n        if (cbCount === num) {\n          return cb(null, cbRetVal);\n        } else if (cbCount > num) {\n          throw new Error(\"reduceCallbacks callback invoked more than requested \" + num + \" times\");\n        }\n      }\n    }\n  };\n};\n\nconcatReduce = function (a, b) {\n  if (!(a instanceof Array)) {\n    a = [a];\n  }\n\n  return a.concat(b);\n};\n\nisInteger = function (i) {\n  return typeof i === 'number' && Math.floor(i) === i;\n};\n\nisBoolean = function (b) {\n  return typeof b === 'boolean';\n};\n\n_setImmediate = function () {\n  var args, func;\n  func = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];\n\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setTimeout : void 0) != null) {\n    return Meteor.setTimeout.apply(Meteor, [func, 0].concat(slice.call(args)));\n  } else if (typeof setImmediate !== \"undefined\" && setImmediate !== null) {\n    return setImmediate.apply(null, [func].concat(slice.call(args)));\n  } else {\n    return setTimeout.apply(null, [func, 0].concat(slice.call(args)));\n  }\n};\n\n_setInterval = function () {\n  var args, func, timeOut;\n  func = arguments[0], timeOut = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];\n\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setInterval : void 0) != null) {\n    return Meteor.setInterval.apply(Meteor, [func, timeOut].concat(slice.call(args)));\n  } else {\n    return setInterval.apply(null, [func, timeOut].concat(slice.call(args)));\n  }\n};\n\n_clearInterval = function (id) {\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.clearInterval : void 0) != null) {\n    return Meteor.clearInterval(id);\n  } else {\n    return clearInterval(id);\n  }\n};\n\nJobQueue = function () {\n  function JobQueue() {\n    var k, options, ref, ref1, ref2, ref3, root1, type1, worker;\n    root1 = arguments[0], type1 = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), worker = arguments[k++];\n    this.root = root1;\n    this.type = type1;\n    this.worker = worker;\n\n    if (!(this instanceof JobQueue)) {\n      return function (func, args, ctor) {\n        ctor.prototype = func.prototype;\n        var child = new ctor(),\n            result = func.apply(child, args);\n        return Object(result) === result ? result : child;\n      }(JobQueue, [this.root, this.type].concat(slice.call(options), [this.worker]), function () {});\n    }\n\n    ref = optionsHelp(options, this.worker), options = ref[0], this.worker = ref[1];\n    this.pollInterval = options.pollInterval != null && !options.pollInterval ? Job.forever : !(options.pollInterval != null && isInteger(options.pollInterval)) ? 5000 : options.pollInterval;\n\n    if (!(isInteger(this.pollInterval) && this.pollInterval >= 0)) {\n      throw new Error(\"JobQueue: Invalid pollInterval, must be a positive integer\");\n    }\n\n    this.concurrency = (ref1 = options.concurrency) != null ? ref1 : 1;\n\n    if (!(isInteger(this.concurrency) && this.concurrency >= 0)) {\n      throw new Error(\"JobQueue: Invalid concurrency, must be a positive integer\");\n    }\n\n    this.payload = (ref2 = options.payload) != null ? ref2 : 1;\n\n    if (!(isInteger(this.payload) && this.payload >= 0)) {\n      throw new Error(\"JobQueue: Invalid payload, must be a positive integer\");\n    }\n\n    this.prefetch = (ref3 = options.prefetch) != null ? ref3 : 0;\n\n    if (!(isInteger(this.prefetch) && this.prefetch >= 0)) {\n      throw new Error(\"JobQueue: Invalid prefetch, must be a positive integer\");\n    }\n\n    this.workTimeout = options.workTimeout;\n\n    if (this.workTimeout != null && !(isInteger(this.workTimeout) && this.workTimeout >= 0)) {\n      throw new Error(\"JobQueue: Invalid workTimeout, must be a positive integer\");\n    }\n\n    this.callbackStrict = options.callbackStrict;\n\n    if (this.callbackStrict != null && !isBoolean(this.callbackStrict)) {\n      throw new Error(\"JobQueue: Invalid callbackStrict, must be a boolean\");\n    }\n\n    this._workers = {};\n    this._tasks = [];\n    this._taskNumber = 0;\n    this._stoppingGetWork = void 0;\n    this._stoppingTasks = void 0;\n    this._interval = null;\n    this._getWorkOutstanding = false;\n    this.paused = true;\n    this.resume();\n  }\n\n  JobQueue.prototype._getWork = function () {\n    var numJobsToGet, options;\n\n    if (!(this._getWorkOutstanding || this.paused)) {\n      numJobsToGet = this.prefetch + this.payload * (this.concurrency - this.running()) - this.length();\n\n      if (numJobsToGet > 0) {\n        this._getWorkOutstanding = true;\n        options = {\n          maxJobs: numJobsToGet\n        };\n\n        if (this.workTimeout != null) {\n          options.workTimeout = this.workTimeout;\n        }\n\n        return Job.getWork(this.root, this.type, options, function (_this) {\n          return function (err, jobs) {\n            var j, k, len;\n            _this._getWorkOutstanding = false;\n\n            if (err) {\n              return console.error(\"JobQueue: Received error from getWork(): \", err);\n            } else if (jobs != null && jobs instanceof Array) {\n              if (jobs.length > numJobsToGet) {\n                console.error(\"JobQueue: getWork() returned jobs (\" + jobs.length + \") in excess of maxJobs (\" + numJobsToGet + \")\");\n              }\n\n              for (k = 0, len = jobs.length; k < len; k++) {\n                j = jobs[k];\n\n                _this._tasks.push(j);\n\n                if (_this._stoppingGetWork == null) {\n                  _setImmediate(_this._process.bind(_this));\n                }\n              }\n\n              if (_this._stoppingGetWork != null) {\n                return _this._stoppingGetWork();\n              }\n            } else {\n              return console.error(\"JobQueue: Nonarray response from server from getWork()\");\n            }\n          };\n        }(this));\n      }\n    }\n  };\n\n  JobQueue.prototype._only_once = function (fn) {\n    var called;\n    called = false;\n    return function (_this) {\n      return function () {\n        if (called) {\n          console.error(\"Worker callback called multiple times in JobQueue\");\n\n          if (_this.callbackStrict) {\n            throw new Error(\"JobQueue worker callback was invoked multiple times\");\n          }\n        }\n\n        called = true;\n        return fn.apply(_this, arguments);\n      };\n    }(this);\n  };\n\n  JobQueue.prototype._process = function () {\n    var cb, job, next;\n\n    if (!this.paused && this.running() < this.concurrency && this.length()) {\n      if (this.payload > 1) {\n        job = this._tasks.splice(0, this.payload);\n      } else {\n        job = this._tasks.shift();\n      }\n\n      job._taskId = \"Task_\" + this._taskNumber++;\n      this._workers[job._taskId] = job;\n\n      next = function (_this) {\n        return function () {\n          delete _this._workers[job._taskId];\n\n          if (_this._stoppingTasks != null && _this.running() === 0 && _this.length() === 0) {\n            return _this._stoppingTasks();\n          } else {\n            _setImmediate(_this._process.bind(_this));\n\n            return _setImmediate(_this._getWork.bind(_this));\n          }\n        };\n      }(this);\n\n      cb = this._only_once(next);\n      return this.worker(job, cb);\n    }\n  };\n\n  JobQueue.prototype._stopGetWork = function (callback) {\n    _clearInterval(this._interval);\n\n    this._interval = null;\n\n    if (this._getWorkOutstanding) {\n      return this._stoppingGetWork = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._waitForTasks = function (callback) {\n    if (this.running() !== 0) {\n      return this._stoppingTasks = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._failJobs = function (tasks, callback) {\n    var count, job, k, len, results;\n\n    if (tasks.length === 0) {\n      _setImmediate(callback);\n    }\n\n    count = 0;\n    results = [];\n\n    for (k = 0, len = tasks.length; k < len; k++) {\n      job = tasks[k];\n      results.push(job.fail(\"Worker shutdown\", function (_this) {\n        return function (err, res) {\n          count++;\n\n          if (count === tasks.length) {\n            return callback();\n          }\n        };\n      }(this)));\n    }\n\n    return results;\n  };\n\n  JobQueue.prototype._hard = function (callback) {\n    this.paused = true;\n    return this._stopGetWork(function (_this) {\n      return function () {\n        var i, r, ref, tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        ref = _this._workers;\n\n        for (i in meteorBabelHelpers.sanitizeForInObject(ref)) {\n          r = ref[i];\n          tasks = tasks.concat(r);\n        }\n\n        return _this._failJobs(tasks, callback);\n      };\n    }(this));\n  };\n\n  JobQueue.prototype._stop = function (callback) {\n    this.paused = true;\n    return this._stopGetWork(function (_this) {\n      return function () {\n        var tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        return _this._waitForTasks(function () {\n          return _this._failJobs(tasks, callback);\n        });\n      };\n    }(this));\n  };\n\n  JobQueue.prototype._soft = function (callback) {\n    return this._stopGetWork(function (_this) {\n      return function () {\n        return _this._waitForTasks(callback);\n      };\n    }(this));\n  };\n\n  JobQueue.prototype.length = function () {\n    return this._tasks.length;\n  };\n\n  JobQueue.prototype.running = function () {\n    return Object.keys(this._workers).length;\n  };\n\n  JobQueue.prototype.idle = function () {\n    return this.length() + this.running() === 0;\n  };\n\n  JobQueue.prototype.full = function () {\n    return this.running() === this.concurrency;\n  };\n\n  JobQueue.prototype.pause = function () {\n    if (this.paused) {\n      return;\n    }\n\n    if (!(this.pollInterval >= Job.forever)) {\n      _clearInterval(this._interval);\n\n      this._interval = null;\n    }\n\n    this.paused = true;\n    return this;\n  };\n\n  JobQueue.prototype.resume = function () {\n    var k, ref, w;\n\n    if (!this.paused) {\n      return;\n    }\n\n    this.paused = false;\n\n    _setImmediate(this._getWork.bind(this));\n\n    if (!(this.pollInterval >= Job.forever)) {\n      this._interval = _setInterval(this._getWork.bind(this), this.pollInterval);\n    }\n\n    for (w = k = 1, ref = this.concurrency; 1 <= ref ? k <= ref : k >= ref; w = 1 <= ref ? ++k : --k) {\n      _setImmediate(this._process.bind(this));\n    }\n\n    return this;\n  };\n\n  JobQueue.prototype.trigger = function () {\n    if (this.paused) {\n      return;\n    }\n\n    _setImmediate(this._getWork.bind(this));\n\n    return this;\n  };\n\n  JobQueue.prototype.shutdown = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.level == null) {\n      options.level = 'normal';\n    }\n\n    if (options.quiet == null) {\n      options.quiet = false;\n    }\n\n    if (cb == null) {\n      if (!options.quiet) {\n        console.warn(\"using default shutdown callback!\");\n      }\n\n      cb = function (_this) {\n        return function () {\n          return console.warn(\"Shutdown complete\");\n        };\n      }(this);\n    }\n\n    switch (options.level) {\n      case 'hard':\n        if (!options.quiet) {\n          console.warn(\"Shutting down hard\");\n        }\n\n        return this._hard(cb);\n\n      case 'soft':\n        if (!options.quiet) {\n          console.warn(\"Shutting down soft\");\n        }\n\n        return this._soft(cb);\n\n      default:\n        if (!options.quiet) {\n          console.warn(\"Shutting down normally\");\n        }\n\n        return this._stop(cb);\n    }\n  };\n\n  return JobQueue;\n}();\n\nJob = function () {\n  Job.forever = 9007199254740992;\n  Job.foreverDate = new Date(8640000000000000);\n  Job.jobPriorities = {\n    low: 10,\n    normal: 0,\n    medium: -5,\n    high: -10,\n    critical: -15\n  };\n  Job.jobRetryBackoffMethods = ['constant', 'exponential'];\n  Job.jobStatuses = ['waiting', 'paused', 'ready', 'running', 'failed', 'cancelled', 'completed'];\n  Job.jobLogLevels = ['info', 'success', 'warning', 'danger'];\n  Job.jobStatusCancellable = ['running', 'ready', 'waiting', 'paused'];\n  Job.jobStatusPausable = ['ready', 'waiting'];\n  Job.jobStatusRemovable = ['cancelled', 'completed', 'failed'];\n  Job.jobStatusRestartable = ['cancelled', 'failed'];\n  Job.ddpMethods = ['startJobs', 'stopJobs', 'startJobServer', 'shutdownJobServer', 'jobRemove', 'jobPause', 'jobResume', 'jobReady', 'jobCancel', 'jobRestart', 'jobSave', 'jobRerun', 'getWork', 'getJob', 'jobLog', 'jobProgress', 'jobDone', 'jobFail'];\n  Job.ddpPermissionLevels = ['admin', 'manager', 'creator', 'worker'];\n  Job.ddpMethodPermissions = {\n    'startJobs': ['startJobs', 'admin'],\n    'stopJobs': ['stopJobs', 'admin'],\n    'startJobServer': ['startJobServer', 'admin'],\n    'shutdownJobServer': ['shutdownJobServer', 'admin'],\n    'jobRemove': ['jobRemove', 'admin', 'manager'],\n    'jobPause': ['jobPause', 'admin', 'manager'],\n    'jobResume': ['jobResume', 'admin', 'manager'],\n    'jobCancel': ['jobCancel', 'admin', 'manager'],\n    'jobReady': ['jobReady', 'admin', 'manager'],\n    'jobRestart': ['jobRestart', 'admin', 'manager'],\n    'jobSave': ['jobSave', 'admin', 'creator'],\n    'jobRerun': ['jobRerun', 'admin', 'creator'],\n    'getWork': ['getWork', 'admin', 'worker'],\n    'getJob': ['getJob', 'admin', 'worker'],\n    'jobLog': ['jobLog', 'admin', 'worker'],\n    'jobProgress': ['jobProgress', 'admin', 'worker'],\n    'jobDone': ['jobDone', 'admin', 'worker'],\n    'jobFail': ['jobFail', 'admin', 'worker']\n  };\n  Job._ddp_apply = void 0;\n\n  Job._setDDPApply = function (apply, collectionName) {\n    if (typeof apply === 'function') {\n      if (typeof collectionName === 'string') {\n        if (this._ddp_apply == null) {\n          this._ddp_apply = {};\n        }\n\n        if (typeof this._ddp_apply === 'function') {\n          throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n        }\n\n        return this._ddp_apply[collectionName] = apply;\n      } else if (!this._ddp_apply) {\n        return this._ddp_apply = apply;\n      } else {\n        throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n      }\n    } else {\n      throw new Error(\"Bad function in Job.setDDPApply()\");\n    }\n  };\n\n  Job.setDDP = function (ddp, collectionNames, Fiber) {\n    var collName, k, len, results;\n\n    if (ddp == null) {\n      ddp = null;\n    }\n\n    if (collectionNames == null) {\n      collectionNames = null;\n    }\n\n    if (Fiber == null) {\n      Fiber = null;\n    }\n\n    if (!(typeof collectionNames === 'string' || collectionNames instanceof Array)) {\n      Fiber = collectionNames;\n      collectionNames = [void 0];\n    } else if (typeof collectionNames === 'string') {\n      collectionNames = [collectionNames];\n    }\n\n    results = [];\n\n    for (k = 0, len = collectionNames.length; k < len; k++) {\n      collName = collectionNames[k];\n\n      if (!(ddp != null && ddp.close != null && ddp.subscribe != null)) {\n        if (ddp === null && (typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.apply : void 0) != null) {\n          results.push(this._setDDPApply(Meteor.apply, collName));\n        } else {\n          throw new Error(\"Bad ddp object in Job.setDDP()\");\n        }\n      } else if (ddp.observe == null) {\n        results.push(this._setDDPApply(ddp.apply.bind(ddp), collName));\n      } else {\n        if (Fiber == null) {\n          results.push(this._setDDPApply(ddp.call.bind(ddp), collName));\n        } else {\n          results.push(this._setDDPApply(function (name, params, cb) {\n            var fib;\n            fib = Fiber.current;\n            ddp.call(name, params, function (err, res) {\n              if (cb != null && typeof cb === 'function') {\n                return cb(err, res);\n              } else {\n                if (err) {\n                  return fib.throwInto(err);\n                } else {\n                  return fib.run(res);\n                }\n              }\n            });\n\n            if (cb != null && typeof cb === 'function') {} else {\n              return Fiber[\"yield\"]();\n            }\n          }, collName));\n        }\n      }\n    }\n\n    return results;\n  };\n\n  Job.getWork = function () {\n    var cb, k, options, ref, root, type;\n    root = arguments[0], type = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (typeof type === 'string') {\n      type = [type];\n    }\n\n    if (options.workTimeout != null) {\n      if (!(isInteger(options.workTimeout) && options.workTimeout > 0)) {\n        throw new Error('getWork: workTimeout must be a positive integer');\n      }\n    }\n\n    return methodCall(root, \"getWork\", [type, options], cb, function (_this) {\n      return function (res) {\n        var doc, jobs;\n\n        jobs = function () {\n          var l, len, results;\n          results = [];\n\n          for (l = 0, len = res.length; l < len; l++) {\n            doc = res[l];\n            results.push(new Job(root, doc));\n          }\n\n          return results;\n        }() || [];\n\n        if (options.maxJobs != null) {\n          return jobs;\n        } else {\n          return jobs[0];\n        }\n      };\n    }(this));\n  };\n\n  Job.processJobs = JobQueue;\n\n  Job.makeJob = function () {\n    var depFlag;\n    depFlag = false;\n    return function (root, doc) {\n      if (!depFlag) {\n        depFlag = true;\n        console.warn(\"Job.makeJob(root, jobDoc) has been deprecated and will be removed in a future release, use 'new Job(root, jobDoc)' instead.\");\n      }\n\n      return new Job(root, doc);\n    };\n  }();\n\n  Job.getJob = function () {\n    var cb, id, k, options, ref, root;\n    root = arguments[0], id = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n\n    return methodCall(root, \"getJob\", [id, options], cb, function (_this) {\n      return function (doc) {\n        if (doc) {\n          return new Job(root, doc);\n        } else {\n          return void 0;\n        }\n      };\n    }(this));\n  };\n\n  Job.getJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n\n    retVal = [];\n    chunksOfIds = splitLongArray(ids, 32);\n    myCb = reduceCallbacks(cb, chunksOfIds.length, concatReduce, []);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = retVal.concat(methodCall(root, \"getJob\", [chunkOfIds, options], myCb, function (_this) {\n        return function (doc) {\n          var d, len1, m, results;\n\n          if (doc) {\n            results = [];\n\n            for (m = 0, len1 = doc.length; m < len1; m++) {\n              d = doc[m];\n              results.push(new Job(root, d.type, d.data, d));\n            }\n\n            return results;\n          } else {\n            return null;\n          }\n        };\n      }(this)));\n    }\n\n    return retVal;\n  };\n\n  Job.pauseJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobPause\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.resumeJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobResume\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.readyJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n\n    if (ids == null) {\n      ids = [];\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.force == null) {\n      options.force = false;\n    }\n\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n\n    if (!(chunksOfIds.length > 0)) {\n      chunksOfIds = [[]];\n    }\n\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobReady\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.cancelJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobCancel\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.restartJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRestart\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.removeJobs = function () {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRemove\", [chunkOfIds, options], myCb) || retVal;\n    }\n\n    return retVal;\n  };\n\n  Job.startJobs = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobs\", [options], cb);\n  };\n\n  Job.stopJobs = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n\n    return methodCall(root, \"stopJobs\", [options], cb);\n  };\n\n  Job.startJobServer = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobServer\", [options], cb);\n  };\n\n  Job.shutdownJobServer = function () {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n\n    return methodCall(root, \"shutdownJobServer\", [options], cb);\n  };\n\n  function Job(root1, type, data) {\n    var doc, ref, time;\n    this.root = root1;\n\n    if (!(this instanceof Job)) {\n      return new Job(this.root, type, data);\n    }\n\n    this._root = this.root;\n\n    if (((ref = this.root) != null ? ref.root : void 0) != null && typeof this.root.root === 'string') {\n      this.root = this._root.root;\n    }\n\n    if (data == null && (type != null ? type.data : void 0) != null && (type != null ? type.type : void 0) != null) {\n      if (type instanceof Job) {\n        return type;\n      }\n\n      doc = type;\n      data = doc.data;\n      type = doc.type;\n    } else {\n      doc = {};\n    }\n\n    if (!((typeof doc === \"undefined\" ? \"undefined\" : _typeof(doc)) === 'object' && (typeof data === \"undefined\" ? \"undefined\" : _typeof(data)) === 'object' && typeof type === 'string' && typeof this.root === 'string')) {\n      throw new Error(\"new Job: bad parameter(s), \" + this.root + \" (\" + _typeof(this.root) + \"), \" + type + \" (\" + (typeof type === \"undefined\" ? \"undefined\" : _typeof(type)) + \"), \" + data + \" (\" + (typeof data === \"undefined\" ? \"undefined\" : _typeof(data)) + \"), \" + doc + \" (\" + (typeof doc === \"undefined\" ? \"undefined\" : _typeof(doc)) + \")\");\n    } else if (doc.type != null && doc.data != null) {\n      this._doc = doc;\n    } else {\n      time = new Date();\n      this._doc = {\n        runId: null,\n        type: type,\n        data: data,\n        status: 'waiting',\n        updated: time,\n        created: time\n      };\n      this.priority().retry().repeat().after().progress().depends().log(\"Constructed\");\n    }\n\n    return this;\n  }\n\n  Job.prototype._echo = function (message, level) {\n    if (level == null) {\n      level = null;\n    }\n\n    switch (level) {\n      case 'danger':\n        console.error(message);\n        break;\n\n      case 'warning':\n        console.warn(message);\n        break;\n\n      case 'success':\n        console.log(message);\n        break;\n\n      default:\n        console.info(message);\n    }\n  };\n\n  Job.prototype.depends = function (jobs) {\n    var depends, j, k, len;\n\n    if (jobs) {\n      if (jobs instanceof Job) {\n        jobs = [jobs];\n      }\n\n      if (jobs instanceof Array) {\n        depends = this._doc.depends;\n\n        for (k = 0, len = jobs.length; k < len; k++) {\n          j = jobs[k];\n\n          if (!(j instanceof Job && j._doc._id != null)) {\n            throw new Error('Each provided object must be a saved Job instance (with an _id)');\n          }\n\n          depends.push(j._doc._id);\n        }\n      } else {\n        throw new Error('Bad input parameter: depends() accepts a falsy value, or Job or array of Jobs');\n      }\n    } else {\n      depends = [];\n    }\n\n    this._doc.depends = depends;\n    this._doc.resolved = [];\n    return this;\n  };\n\n  Job.prototype.priority = function (level) {\n    var priority;\n\n    if (level == null) {\n      level = 0;\n    }\n\n    if (typeof level === 'string') {\n      priority = Job.jobPriorities[level];\n\n      if (priority == null) {\n        throw new Error('Invalid string priority level provided');\n      }\n    } else if (isInteger(level)) {\n      priority = level;\n    } else {\n      throw new Error('priority must be an integer or valid priority level');\n      priority = 0;\n    }\n\n    this._doc.priority = priority;\n    return this;\n  };\n\n  Job.prototype.retry = function (options) {\n    var base, ref;\n\n    if (options == null) {\n      options = 0;\n    }\n\n    if (isInteger(options) && options >= 0) {\n      options = {\n        retries: options\n      };\n    }\n\n    if ((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n\n    if (options.retries != null) {\n      if (!(isInteger(options.retries) && options.retries >= 0)) {\n        throw new Error('bad option: retries must be an integer >= 0');\n      }\n\n      options.retries++;\n    } else {\n      options.retries = Job.forever;\n    }\n\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n\n    if (options.backoff != null) {\n      if (ref = options.backoff, indexOf.call(Job.jobRetryBackoffMethods, ref) < 0) {\n        throw new Error('bad option: invalid retry backoff method');\n      }\n    } else {\n      options.backoff = 'constant';\n    }\n\n    this._doc.retries = options.retries;\n    this._doc.repeatRetries = options.retries;\n    this._doc.retryWait = options.wait;\n\n    if ((base = this._doc).retried == null) {\n      base.retried = 0;\n    }\n\n    this._doc.retryBackoff = options.backoff;\n    this._doc.retryUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.repeat = function (options) {\n    var base, ref;\n\n    if (options == null) {\n      options = 0;\n    }\n\n    if (isInteger(options) && options >= 0) {\n      options = {\n        repeats: options\n      };\n    }\n\n    if ((typeof options === \"undefined\" ? \"undefined\" : _typeof(options)) !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n\n    if (options.wait != null && options.schedule != null) {\n      throw new Error('bad options: wait and schedule options are mutually exclusive');\n    }\n\n    if (options.repeats != null) {\n      if (!(isInteger(options.repeats) && options.repeats >= 0)) {\n        throw new Error('bad option: repeats must be an integer >= 0');\n      }\n    } else {\n      options.repeats = Job.forever;\n    }\n\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n\n    if (options.schedule != null) {\n      if (_typeof(options.schedule) !== 'object') {\n        throw new Error('bad option, schedule option must be an object');\n      }\n\n      if (!(((ref = options.schedule) != null ? ref.schedules : void 0) != null && options.schedule.schedules instanceof Array)) {\n        throw new Error('bad option, schedule object requires a schedules attribute of type Array.');\n      }\n\n      if (options.schedule.exceptions != null && !(options.schedule.exceptions instanceof Array)) {\n        throw new Error('bad option, schedule object exceptions attribute must be an Array');\n      }\n\n      options.wait = {\n        schedules: options.schedule.schedules,\n        exceptions: options.schedule.exceptions\n      };\n    }\n\n    this._doc.repeats = options.repeats;\n    this._doc.repeatWait = options.wait;\n\n    if ((base = this._doc).repeated == null) {\n      base.repeated = 0;\n    }\n\n    this._doc.repeatUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.delay = function (wait) {\n    if (wait == null) {\n      wait = 0;\n    }\n\n    if (!(isInteger(wait) && wait >= 0)) {\n      throw new Error('Bad parameter, delay requires a non-negative integer.');\n    }\n\n    return this.after(new Date(new Date().valueOf() + wait));\n  };\n\n  Job.prototype.after = function (time) {\n    var after;\n\n    if (time == null) {\n      time = new Date(0);\n    }\n\n    if ((typeof time === \"undefined\" ? \"undefined\" : _typeof(time)) === 'object' && time instanceof Date) {\n      after = time;\n    } else {\n      throw new Error('Bad parameter, after requires a valid Date object');\n    }\n\n    this._doc.after = after;\n    return this;\n  };\n\n  Job.prototype.log = function () {\n    var base, cb, k, message, options, ref, ref1;\n    message = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.level == null) {\n      options.level = 'info';\n    }\n\n    if (typeof message !== 'string') {\n      throw new Error('Log message must be a string');\n    }\n\n    if (!(typeof options.level === 'string' && (ref1 = options.level, indexOf.call(Job.jobLogLevels, ref1) >= 0))) {\n      throw new Error('Log level options must be one of Job.jobLogLevels');\n    }\n\n    if (options.echo != null) {\n      if (options.echo && Job.jobLogLevels.indexOf(options.level) >= Job.jobLogLevels.indexOf(options.echo)) {\n        this._echo(\"LOG: \" + options.level + \", \" + this._doc._id + \" \" + this._doc.runId + \": \" + message, options.level);\n      }\n\n      delete options.echo;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobLog\", [this._doc._id, this._doc.runId, message, options], cb);\n    } else {\n      if ((base = this._doc).log == null) {\n        base.log = [];\n      }\n\n      this._doc.log.push({\n        time: new Date(),\n        runId: null,\n        level: options.level,\n        message: message\n      });\n\n      if (cb != null && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n\n      return this;\n    }\n  };\n\n  Job.prototype.progress = function () {\n    var cb, completed, k, options, progress, ref, total;\n    completed = arguments[0], total = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n\n    if (completed == null) {\n      completed = 0;\n    }\n\n    if (total == null) {\n      total = 1;\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (typeof completed === 'number' && typeof total === 'number' && completed >= 0 && total > 0 && total >= completed) {\n      progress = {\n        completed: completed,\n        total: total,\n        percent: 100 * completed / total\n      };\n\n      if (options.echo) {\n        delete options.echo;\n\n        this._echo(\"PROGRESS: \" + this._doc._id + \" \" + this._doc.runId + \": \" + progress.completed + \" out of \" + progress.total + \" (\" + progress.percent + \"%)\");\n      }\n\n      if (this._doc._id != null && this._doc.runId != null) {\n        return methodCall(this._root, \"jobProgress\", [this._doc._id, this._doc.runId, completed, total, options], cb, function (_this) {\n          return function (res) {\n            if (res) {\n              _this._doc.progress = progress;\n            }\n\n            return res;\n          };\n        }(this));\n      } else if (this._doc._id == null) {\n        this._doc.progress = progress;\n\n        if (cb != null && typeof cb === 'function') {\n          _setImmediate(cb, null, true);\n        }\n\n        return this;\n      }\n    } else {\n      throw new Error(\"job.progress: something is wrong with progress params: \" + this.id + \", \" + completed + \" out of \" + total);\n    }\n\n    return null;\n  };\n\n  Job.prototype.save = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(this._root, \"jobSave\", [this._doc, options], cb, function (_this) {\n      return function (id) {\n        if (id) {\n          _this._doc._id = id;\n        }\n\n        return id;\n      };\n    }(this));\n  };\n\n  Job.prototype.refresh = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"getJob\", [this._doc._id, options], cb, function (_this) {\n        return function (doc) {\n          if (doc != null) {\n            _this._doc = doc;\n            return _this;\n          } else {\n            return false;\n          }\n        };\n      }(this));\n    } else {\n      throw new Error(\"Can't call .refresh() on an unsaved job\");\n    }\n  };\n\n  Job.prototype.done = function () {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n\n    if (result == null) {\n      result = {};\n    }\n\n    if (typeof result === 'function') {\n      cb = result;\n      result = {};\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (!(result != null && (typeof result === \"undefined\" ? \"undefined\" : _typeof(result)) === 'object')) {\n      result = {\n        value: result\n      };\n    }\n\n    if (this._doc._id != null && this._doc.runId != null) {\n      return methodCall(this._root, \"jobDone\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .done() on an unsaved or non-running job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.fail = function () {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n\n    if (result == null) {\n      result = \"No error information provided\";\n    }\n\n    if (typeof result === 'function') {\n      cb = result;\n      result = \"No error information provided\";\n    }\n\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (!(result != null && (typeof result === \"undefined\" ? \"undefined\" : _typeof(result)) === 'object')) {\n      result = {\n        value: result\n      };\n    }\n\n    if (options.fatal == null) {\n      options.fatal = false;\n    }\n\n    if (this._doc._id != null && this._doc.runId != null) {\n      return methodCall(this._root, \"jobFail\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .fail() on an unsaved or non-running job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.pause = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobPause\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'paused';\n\n      if (cb != null && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n\n      return this;\n    }\n\n    return null;\n  };\n\n  Job.prototype.resume = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobResume\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'waiting';\n\n      if (cb != null && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n\n      return this;\n    }\n\n    return null;\n  };\n\n  Job.prototype.ready = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.force == null) {\n      options.force = false;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobReady\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .ready() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.cancel = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobCancel\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .cancel() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.restart = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRestart\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .restart() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.rerun = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (options.repeats == null) {\n      options.repeats = 0;\n    }\n\n    if (options.wait == null) {\n      options.wait = this._doc.repeatWait;\n    }\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRerun\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .rerun() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Job.prototype.remove = function () {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRemove\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .remove() on an unsaved job\");\n    }\n\n    return null;\n  };\n\n  Object.defineProperties(Job.prototype, {\n    doc: {\n      get: function () {\n        return this._doc;\n      },\n      set: function () {\n        return console.warn(\"Job.doc cannot be directly assigned.\");\n      }\n    },\n    type: {\n      get: function () {\n        return this._doc.type;\n      },\n      set: function () {\n        return console.warn(\"Job.type cannot be directly assigned.\");\n      }\n    },\n    data: {\n      get: function () {\n        return this._doc.data;\n      },\n      set: function () {\n        return console.warn(\"Job.data cannot be directly assigned.\");\n      }\n    }\n  });\n  return Job;\n}();\n\nif ((typeof module !== \"undefined\" && module !== null ? module.exports : void 0) != null) {\n  module.exports = Job;\n}","ast":null,"map":{"version":3,"sources":["/packages/vsivsi:job-collection/job/src/job_class.coffee"],"names":["JobQueue","_clearInterval","_setImmediate","_setInterval","concatReduce","isBoolean","isInteger","methodCall","optionsHelp","reduceCallbacks","splitLongArray","slice","indexOf","item","i","l","length","root","method","params","cb","after","apply","name","ref","ref1","ref2","ref3","ret","Job","_ddp_apply","Error","_this","err","res","options","Array","arr","max","k","results","Math","ceil","push","num","reduce","init","cbCount","cbErr","cbRetVal","a","b","concat","floor","args","func","arguments","call","Meteor","setTimeout","setImmediate","timeOut","setInterval","id","clearInterval","root1","type1","worker","type","ctor","prototype","child","result","Object","pollInterval","forever","concurrency","payload","prefetch","workTimeout","callbackStrict","_workers","_tasks","_taskNumber","_stoppingGetWork","_stoppingTasks","_interval","_getWorkOutstanding","paused","resume","_getWork","numJobsToGet","running","maxJobs","getWork","jobs","j","len","console","error","_process","bind","_only_once","fn","called","job","next","splice","shift","_taskId","_stopGetWork","callback","_waitForTasks","_failJobs","tasks","count","fail","_hard","r","_stop","_soft","keys","idle","full","pause","w","trigger","shutdown","level","quiet","warn","foreverDate","Date","jobPriorities","low","normal","medium","high","critical","jobRetryBackoffMethods","jobStatuses","jobLogLevels","jobStatusCancellable","jobStatusPausable","jobStatusRemovable","jobStatusRestartable","ddpMethods","ddpPermissionLevels","ddpMethodPermissions","_setDDPApply","collectionName","setDDP","ddp","collectionNames","Fiber","collName","close","subscribe","observe","fib","current","throwInto","run","doc","processJobs","makeJob","depFlag","getJob","getLog","getJobs","chunkOfIds","chunksOfIds","ids","myCb","retVal","d","len1","m","data","pauseJobs","resumeJobs","readyJobs","force","cancelJobs","antecedents","restartJobs","retries","dependents","removeJobs","startJobs","stopJobs","timeout","startJobServer","shutdownJobServer","time","_root","_doc","runId","status","updated","created","priority","retry","repeat","progress","depends","log","_echo","message","info","_id","resolved","base","until","wait","backoff","repeatRetries","retryWait","retried","retryBackoff","retryUntil","repeats","schedule","schedules","exceptions","repeatWait","repeated","repeatUntil","delay","valueOf","echo","completed","total","percent","save","refresh","done","value","fatal","ready","cancel","restart","rerun","remove","defineProperties","get","set","module","exports"],"mappings":"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","file":"/packages/vsivsi:job-collection/job/src/job_class.coffee.map","sourcesContent":["var JobQueue, _clearInterval, _setImmediate, _setInterval, concatReduce, isBoolean, isInteger, methodCall, optionsHelp, reduceCallbacks, splitLongArray,     \n  slice = [].slice,\n  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };\n\nmethodCall = function(root, method, params, cb, after) {\n  var apply, name, ref, ref1, ref2, ref3;\n  if (after == null) {\n    after = (function(ret) {\n      return ret;\n    });\n  }\n  apply = (ref = (ref1 = Job._ddp_apply) != null ? ref1[(ref2 = root.root) != null ? ref2 : root] : void 0) != null ? ref : Job._ddp_apply;\n  if (typeof apply !== 'function') {\n    throw new Error(\"Job remote method call error, no valid invocation method found.\");\n  }\n  name = ((ref3 = root.root) != null ? ref3 : root) + \"_\" + method;\n  if (cb && typeof cb === 'function') {\n    return apply(name, params, (function(_this) {\n      return function(err, res) {\n        if (err) {\n          return cb(err);\n        }\n        return cb(null, after(res));\n      };\n    })(this));\n  } else {\n    return after(apply(name, params));\n  }\n};\n\noptionsHelp = function(options, cb) {\n  var ref;\n  if ((cb != null) && typeof cb !== 'function') {\n    options = cb;\n    cb = void 0;\n  } else {\n    if (!(typeof options === 'object' && options instanceof Array && options.length < 2)) {\n      throw new Error('options... in optionsHelp must be an Array with zero or one elements');\n    }\n    options = (ref = options != null ? options[0] : void 0) != null ? ref : {};\n  }\n  if (typeof options !== 'object') {\n    throw new Error('in optionsHelp options not an object or bad callback');\n  }\n  return [options, cb];\n};\n\nsplitLongArray = function(arr, max) {\n  var i, k, ref, results;\n  if (!(arr instanceof Array && max > 0)) {\n    throw new Error('splitLongArray: bad params');\n  }\n  results = [];\n  for (i = k = 0, ref = Math.ceil(arr.length / max); 0 <= ref ? k < ref : k > ref; i = 0 <= ref ? ++k : --k) {\n    results.push(arr.slice(i * max, (i + 1) * max));\n  }\n  return results;\n};\n\nreduceCallbacks = function(cb, num, reduce, init) {\n  var cbCount, cbErr, cbRetVal;\n  if (reduce == null) {\n    reduce = (function(a, b) {\n      return a || b;\n    });\n  }\n  if (init == null) {\n    init = false;\n  }\n  if (cb == null) {\n    return void 0;\n  }\n  if (!(typeof cb === 'function' && num > 0 && typeof reduce === 'function')) {\n    throw new Error('Bad params given to reduceCallbacks');\n  }\n  cbRetVal = init;\n  cbCount = 0;\n  cbErr = null;\n  return function(err, res) {\n    if (!cbErr) {\n      if (err) {\n        cbErr = err;\n        return cb(err);\n      } else {\n        cbCount++;\n        cbRetVal = reduce(cbRetVal, res);\n        if (cbCount === num) {\n          return cb(null, cbRetVal);\n        } else if (cbCount > num) {\n          throw new Error(\"reduceCallbacks callback invoked more than requested \" + num + \" times\");\n        }\n      }\n    }\n  };\n};\n\nconcatReduce = function(a, b) {\n  if (!(a instanceof Array)) {\n    a = [a];\n  }\n  return a.concat(b);\n};\n\nisInteger = function(i) {\n  return typeof i === 'number' && Math.floor(i) === i;\n};\n\nisBoolean = function(b) {\n  return typeof b === 'boolean';\n};\n\n_setImmediate = function() {\n  var args, func;\n  func = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setTimeout : void 0) != null) {\n    return Meteor.setTimeout.apply(Meteor, [func, 0].concat(slice.call(args)));\n  } else if (typeof setImmediate !== \"undefined\" && setImmediate !== null) {\n    return setImmediate.apply(null, [func].concat(slice.call(args)));\n  } else {\n    return setTimeout.apply(null, [func, 0].concat(slice.call(args)));\n  }\n};\n\n_setInterval = function() {\n  var args, func, timeOut;\n  func = arguments[0], timeOut = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.setInterval : void 0) != null) {\n    return Meteor.setInterval.apply(Meteor, [func, timeOut].concat(slice.call(args)));\n  } else {\n    return setInterval.apply(null, [func, timeOut].concat(slice.call(args)));\n  }\n};\n\n_clearInterval = function(id) {\n  if ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.clearInterval : void 0) != null) {\n    return Meteor.clearInterval(id);\n  } else {\n    return clearInterval(id);\n  }\n};\n\nJobQueue = (function() {\n  function JobQueue() {\n    var k, options, ref, ref1, ref2, ref3, root1, type1, worker;\n    root1 = arguments[0], type1 = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), worker = arguments[k++];\n    this.root = root1;\n    this.type = type1;\n    this.worker = worker;\n    if (!(this instanceof JobQueue)) {\n      return (function(func, args, ctor) {\n        ctor.prototype = func.prototype;\n        var child = new ctor, result = func.apply(child, args);\n        return Object(result) === result ? result : child;\n      })(JobQueue, [this.root, this.type].concat(slice.call(options), [this.worker]), function(){});\n    }\n    ref = optionsHelp(options, this.worker), options = ref[0], this.worker = ref[1];\n    this.pollInterval = (options.pollInterval != null) && !options.pollInterval ? Job.forever : !((options.pollInterval != null) && isInteger(options.pollInterval)) ? 5000 : options.pollInterval;\n    if (!(isInteger(this.pollInterval) && this.pollInterval >= 0)) {\n      throw new Error(\"JobQueue: Invalid pollInterval, must be a positive integer\");\n    }\n    this.concurrency = (ref1 = options.concurrency) != null ? ref1 : 1;\n    if (!(isInteger(this.concurrency) && this.concurrency >= 0)) {\n      throw new Error(\"JobQueue: Invalid concurrency, must be a positive integer\");\n    }\n    this.payload = (ref2 = options.payload) != null ? ref2 : 1;\n    if (!(isInteger(this.payload) && this.payload >= 0)) {\n      throw new Error(\"JobQueue: Invalid payload, must be a positive integer\");\n    }\n    this.prefetch = (ref3 = options.prefetch) != null ? ref3 : 0;\n    if (!(isInteger(this.prefetch) && this.prefetch >= 0)) {\n      throw new Error(\"JobQueue: Invalid prefetch, must be a positive integer\");\n    }\n    this.workTimeout = options.workTimeout;\n    if ((this.workTimeout != null) && !(isInteger(this.workTimeout) && this.workTimeout >= 0)) {\n      throw new Error(\"JobQueue: Invalid workTimeout, must be a positive integer\");\n    }\n    this.callbackStrict = options.callbackStrict;\n    if ((this.callbackStrict != null) && !isBoolean(this.callbackStrict)) {\n      throw new Error(\"JobQueue: Invalid callbackStrict, must be a boolean\");\n    }\n    this._workers = {};\n    this._tasks = [];\n    this._taskNumber = 0;\n    this._stoppingGetWork = void 0;\n    this._stoppingTasks = void 0;\n    this._interval = null;\n    this._getWorkOutstanding = false;\n    this.paused = true;\n    this.resume();\n  }\n\n  JobQueue.prototype._getWork = function() {\n    var numJobsToGet, options;\n    if (!(this._getWorkOutstanding || this.paused)) {\n      numJobsToGet = this.prefetch + this.payload * (this.concurrency - this.running()) - this.length();\n      if (numJobsToGet > 0) {\n        this._getWorkOutstanding = true;\n        options = {\n          maxJobs: numJobsToGet\n        };\n        if (this.workTimeout != null) {\n          options.workTimeout = this.workTimeout;\n        }\n        return Job.getWork(this.root, this.type, options, (function(_this) {\n          return function(err, jobs) {\n            var j, k, len;\n            _this._getWorkOutstanding = false;\n            if (err) {\n              return console.error(\"JobQueue: Received error from getWork(): \", err);\n            } else if ((jobs != null) && jobs instanceof Array) {\n              if (jobs.length > numJobsToGet) {\n                console.error(\"JobQueue: getWork() returned jobs (\" + jobs.length + \") in excess of maxJobs (\" + numJobsToGet + \")\");\n              }\n              for (k = 0, len = jobs.length; k < len; k++) {\n                j = jobs[k];\n                _this._tasks.push(j);\n                if (_this._stoppingGetWork == null) {\n                  _setImmediate(_this._process.bind(_this));\n                }\n              }\n              if (_this._stoppingGetWork != null) {\n                return _this._stoppingGetWork();\n              }\n            } else {\n              return console.error(\"JobQueue: Nonarray response from server from getWork()\");\n            }\n          };\n        })(this));\n      }\n    }\n  };\n\n  JobQueue.prototype._only_once = function(fn) {\n    var called;\n    called = false;\n    return (function(_this) {\n      return function() {\n        if (called) {\n          console.error(\"Worker callback called multiple times in JobQueue\");\n          if (_this.callbackStrict) {\n            throw new Error(\"JobQueue worker callback was invoked multiple times\");\n          }\n        }\n        called = true;\n        return fn.apply(_this, arguments);\n      };\n    })(this);\n  };\n\n  JobQueue.prototype._process = function() {\n    var cb, job, next;\n    if (!this.paused && this.running() < this.concurrency && this.length()) {\n      if (this.payload > 1) {\n        job = this._tasks.splice(0, this.payload);\n      } else {\n        job = this._tasks.shift();\n      }\n      job._taskId = \"Task_\" + (this._taskNumber++);\n      this._workers[job._taskId] = job;\n      next = (function(_this) {\n        return function() {\n          delete _this._workers[job._taskId];\n          if ((_this._stoppingTasks != null) && _this.running() === 0 && _this.length() === 0) {\n            return _this._stoppingTasks();\n          } else {\n            _setImmediate(_this._process.bind(_this));\n            return _setImmediate(_this._getWork.bind(_this));\n          }\n        };\n      })(this);\n      cb = this._only_once(next);\n      return this.worker(job, cb);\n    }\n  };\n\n  JobQueue.prototype._stopGetWork = function(callback) {\n    _clearInterval(this._interval);\n    this._interval = null;\n    if (this._getWorkOutstanding) {\n      return this._stoppingGetWork = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._waitForTasks = function(callback) {\n    if (this.running() !== 0) {\n      return this._stoppingTasks = callback;\n    } else {\n      return _setImmediate(callback);\n    }\n  };\n\n  JobQueue.prototype._failJobs = function(tasks, callback) {\n    var count, job, k, len, results;\n    if (tasks.length === 0) {\n      _setImmediate(callback);\n    }\n    count = 0;\n    results = [];\n    for (k = 0, len = tasks.length; k < len; k++) {\n      job = tasks[k];\n      results.push(job.fail(\"Worker shutdown\", (function(_this) {\n        return function(err, res) {\n          count++;\n          if (count === tasks.length) {\n            return callback();\n          }\n        };\n      })(this)));\n    }\n    return results;\n  };\n\n  JobQueue.prototype._hard = function(callback) {\n    this.paused = true;\n    return this._stopGetWork((function(_this) {\n      return function() {\n        var i, r, ref, tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        ref = _this._workers;\n        for (i in ref) {\n          r = ref[i];\n          tasks = tasks.concat(r);\n        }\n        return _this._failJobs(tasks, callback);\n      };\n    })(this));\n  };\n\n  JobQueue.prototype._stop = function(callback) {\n    this.paused = true;\n    return this._stopGetWork((function(_this) {\n      return function() {\n        var tasks;\n        tasks = _this._tasks;\n        _this._tasks = [];\n        return _this._waitForTasks(function() {\n          return _this._failJobs(tasks, callback);\n        });\n      };\n    })(this));\n  };\n\n  JobQueue.prototype._soft = function(callback) {\n    return this._stopGetWork((function(_this) {\n      return function() {\n        return _this._waitForTasks(callback);\n      };\n    })(this));\n  };\n\n  JobQueue.prototype.length = function() {\n    return this._tasks.length;\n  };\n\n  JobQueue.prototype.running = function() {\n    return Object.keys(this._workers).length;\n  };\n\n  JobQueue.prototype.idle = function() {\n    return this.length() + this.running() === 0;\n  };\n\n  JobQueue.prototype.full = function() {\n    return this.running() === this.concurrency;\n  };\n\n  JobQueue.prototype.pause = function() {\n    if (this.paused) {\n      return;\n    }\n    if (!(this.pollInterval >= Job.forever)) {\n      _clearInterval(this._interval);\n      this._interval = null;\n    }\n    this.paused = true;\n    return this;\n  };\n\n  JobQueue.prototype.resume = function() {\n    var k, ref, w;\n    if (!this.paused) {\n      return;\n    }\n    this.paused = false;\n    _setImmediate(this._getWork.bind(this));\n    if (!(this.pollInterval >= Job.forever)) {\n      this._interval = _setInterval(this._getWork.bind(this), this.pollInterval);\n    }\n    for (w = k = 1, ref = this.concurrency; 1 <= ref ? k <= ref : k >= ref; w = 1 <= ref ? ++k : --k) {\n      _setImmediate(this._process.bind(this));\n    }\n    return this;\n  };\n\n  JobQueue.prototype.trigger = function() {\n    if (this.paused) {\n      return;\n    }\n    _setImmediate(this._getWork.bind(this));\n    return this;\n  };\n\n  JobQueue.prototype.shutdown = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.level == null) {\n      options.level = 'normal';\n    }\n    if (options.quiet == null) {\n      options.quiet = false;\n    }\n    if (cb == null) {\n      if (!options.quiet) {\n        console.warn(\"using default shutdown callback!\");\n      }\n      cb = (function(_this) {\n        return function() {\n          return console.warn(\"Shutdown complete\");\n        };\n      })(this);\n    }\n    switch (options.level) {\n      case 'hard':\n        if (!options.quiet) {\n          console.warn(\"Shutting down hard\");\n        }\n        return this._hard(cb);\n      case 'soft':\n        if (!options.quiet) {\n          console.warn(\"Shutting down soft\");\n        }\n        return this._soft(cb);\n      default:\n        if (!options.quiet) {\n          console.warn(\"Shutting down normally\");\n        }\n        return this._stop(cb);\n    }\n  };\n\n  return JobQueue;\n\n})();\n\nJob = (function() {\n  Job.forever = 9007199254740992;\n\n  Job.foreverDate = new Date(8640000000000000);\n\n  Job.jobPriorities = {\n    low: 10,\n    normal: 0,\n    medium: -5,\n    high: -10,\n    critical: -15\n  };\n\n  Job.jobRetryBackoffMethods = ['constant', 'exponential'];\n\n  Job.jobStatuses = ['waiting', 'paused', 'ready', 'running', 'failed', 'cancelled', 'completed'];\n\n  Job.jobLogLevels = ['info', 'success', 'warning', 'danger'];\n\n  Job.jobStatusCancellable = ['running', 'ready', 'waiting', 'paused'];\n\n  Job.jobStatusPausable = ['ready', 'waiting'];\n\n  Job.jobStatusRemovable = ['cancelled', 'completed', 'failed'];\n\n  Job.jobStatusRestartable = ['cancelled', 'failed'];\n\n  Job.ddpMethods = ['startJobs', 'stopJobs', 'startJobServer', 'shutdownJobServer', 'jobRemove', 'jobPause', 'jobResume', 'jobReady', 'jobCancel', 'jobRestart', 'jobSave', 'jobRerun', 'getWork', 'getJob', 'jobLog', 'jobProgress', 'jobDone', 'jobFail'];\n\n  Job.ddpPermissionLevels = ['admin', 'manager', 'creator', 'worker'];\n\n  Job.ddpMethodPermissions = {\n    'startJobs': ['startJobs', 'admin'],\n    'stopJobs': ['stopJobs', 'admin'],\n    'startJobServer': ['startJobServer', 'admin'],\n    'shutdownJobServer': ['shutdownJobServer', 'admin'],\n    'jobRemove': ['jobRemove', 'admin', 'manager'],\n    'jobPause': ['jobPause', 'admin', 'manager'],\n    'jobResume': ['jobResume', 'admin', 'manager'],\n    'jobCancel': ['jobCancel', 'admin', 'manager'],\n    'jobReady': ['jobReady', 'admin', 'manager'],\n    'jobRestart': ['jobRestart', 'admin', 'manager'],\n    'jobSave': ['jobSave', 'admin', 'creator'],\n    'jobRerun': ['jobRerun', 'admin', 'creator'],\n    'getWork': ['getWork', 'admin', 'worker'],\n    'getJob': ['getJob', 'admin', 'worker'],\n    'jobLog': ['jobLog', 'admin', 'worker'],\n    'jobProgress': ['jobProgress', 'admin', 'worker'],\n    'jobDone': ['jobDone', 'admin', 'worker'],\n    'jobFail': ['jobFail', 'admin', 'worker']\n  };\n\n  Job._ddp_apply = void 0;\n\n  Job._setDDPApply = function(apply, collectionName) {\n    if (typeof apply === 'function') {\n      if (typeof collectionName === 'string') {\n        if (this._ddp_apply == null) {\n          this._ddp_apply = {};\n        }\n        if (typeof this._ddp_apply === 'function') {\n          throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n        }\n        return this._ddp_apply[collectionName] = apply;\n      } else if (!this._ddp_apply) {\n        return this._ddp_apply = apply;\n      } else {\n        throw new Error(\"Job.setDDP must specify a collection name each time if called more than once.\");\n      }\n    } else {\n      throw new Error(\"Bad function in Job.setDDPApply()\");\n    }\n  };\n\n  Job.setDDP = function(ddp, collectionNames, Fiber) {\n    var collName, k, len, results;\n    if (ddp == null) {\n      ddp = null;\n    }\n    if (collectionNames == null) {\n      collectionNames = null;\n    }\n    if (Fiber == null) {\n      Fiber = null;\n    }\n    if (!((typeof collectionNames === 'string') || (collectionNames instanceof Array))) {\n      Fiber = collectionNames;\n      collectionNames = [void 0];\n    } else if (typeof collectionNames === 'string') {\n      collectionNames = [collectionNames];\n    }\n    results = [];\n    for (k = 0, len = collectionNames.length; k < len; k++) {\n      collName = collectionNames[k];\n      if (!((ddp != null) && (ddp.close != null) && (ddp.subscribe != null))) {\n        if (ddp === null && ((typeof Meteor !== \"undefined\" && Meteor !== null ? Meteor.apply : void 0) != null)) {\n          results.push(this._setDDPApply(Meteor.apply, collName));\n        } else {\n          throw new Error(\"Bad ddp object in Job.setDDP()\");\n        }\n      } else if (ddp.observe == null) {\n        results.push(this._setDDPApply(ddp.apply.bind(ddp), collName));\n      } else {\n        if (Fiber == null) {\n          results.push(this._setDDPApply(ddp.call.bind(ddp), collName));\n        } else {\n          results.push(this._setDDPApply((function(name, params, cb) {\n            var fib;\n            fib = Fiber.current;\n            ddp.call(name, params, function(err, res) {\n              if ((cb != null) && typeof cb === 'function') {\n                return cb(err, res);\n              } else {\n                if (err) {\n                  return fib.throwInto(err);\n                } else {\n                  return fib.run(res);\n                }\n              }\n            });\n            if ((cb != null) && typeof cb === 'function') {\n\n            } else {\n              return Fiber[\"yield\"]();\n            }\n          }), collName));\n        }\n      }\n    }\n    return results;\n  };\n\n  Job.getWork = function() {\n    var cb, k, options, ref, root, type;\n    root = arguments[0], type = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (typeof type === 'string') {\n      type = [type];\n    }\n    if (options.workTimeout != null) {\n      if (!(isInteger(options.workTimeout) && options.workTimeout > 0)) {\n        throw new Error('getWork: workTimeout must be a positive integer');\n      }\n    }\n    return methodCall(root, \"getWork\", [type, options], cb, (function(_this) {\n      return function(res) {\n        var doc, jobs;\n        jobs = ((function() {\n          var l, len, results;\n          results = [];\n          for (l = 0, len = res.length; l < len; l++) {\n            doc = res[l];\n            results.push(new Job(root, doc));\n          }\n          return results;\n        })()) || [];\n        if (options.maxJobs != null) {\n          return jobs;\n        } else {\n          return jobs[0];\n        }\n      };\n    })(this));\n  };\n\n  Job.processJobs = JobQueue;\n\n  Job.makeJob = (function() {\n    var depFlag;\n    depFlag = false;\n    return function(root, doc) {\n      if (!depFlag) {\n        depFlag = true;\n        console.warn(\"Job.makeJob(root, jobDoc) has been deprecated and will be removed in a future release, use 'new Job(root, jobDoc)' instead.\");\n      }\n      return new Job(root, doc);\n    };\n  })();\n\n  Job.getJob = function() {\n    var cb, id, k, options, ref, root;\n    root = arguments[0], id = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n    return methodCall(root, \"getJob\", [id, options], cb, (function(_this) {\n      return function(doc) {\n        if (doc) {\n          return new Job(root, doc);\n        } else {\n          return void 0;\n        }\n      };\n    })(this));\n  };\n\n  Job.getJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n    retVal = [];\n    chunksOfIds = splitLongArray(ids, 32);\n    myCb = reduceCallbacks(cb, chunksOfIds.length, concatReduce, []);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = retVal.concat(methodCall(root, \"getJob\", [chunkOfIds, options], myCb, (function(_this) {\n        return function(doc) {\n          var d, len1, m, results;\n          if (doc) {\n            results = [];\n            for (m = 0, len1 = doc.length; m < len1; m++) {\n              d = doc[m];\n              results.push(new Job(root, d.type, d.data, d));\n            }\n            return results;\n          } else {\n            return null;\n          }\n        };\n      })(this)));\n    }\n    return retVal;\n  };\n\n  Job.pauseJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobPause\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.resumeJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobResume\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.readyJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    if (ids == null) {\n      ids = [];\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.force == null) {\n      options.force = false;\n    }\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    if (!(chunksOfIds.length > 0)) {\n      chunksOfIds = [[]];\n    }\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobReady\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.cancelJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobCancel\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.restartJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRestart\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.removeJobs = function() {\n    var cb, chunkOfIds, chunksOfIds, ids, k, l, len, myCb, options, ref, retVal, root;\n    root = arguments[0], ids = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    retVal = false;\n    chunksOfIds = splitLongArray(ids, 256);\n    myCb = reduceCallbacks(cb, chunksOfIds.length);\n    for (l = 0, len = chunksOfIds.length; l < len; l++) {\n      chunkOfIds = chunksOfIds[l];\n      retVal = methodCall(root, \"jobRemove\", [chunkOfIds, options], myCb) || retVal;\n    }\n    return retVal;\n  };\n\n  Job.startJobs = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobs\", [options], cb);\n  };\n\n  Job.stopJobs = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n    return methodCall(root, \"stopJobs\", [options], cb);\n  };\n\n  Job.startJobServer = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(root, \"startJobServer\", [options], cb);\n  };\n\n  Job.shutdownJobServer = function() {\n    var cb, k, options, ref, root;\n    root = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.timeout == null) {\n      options.timeout = 60 * 1000;\n    }\n    return methodCall(root, \"shutdownJobServer\", [options], cb);\n  };\n\n  function Job(root1, type, data) {\n    var doc, ref, time;\n    this.root = root1;\n    if (!(this instanceof Job)) {\n      return new Job(this.root, type, data);\n    }\n    this._root = this.root;\n    if ((((ref = this.root) != null ? ref.root : void 0) != null) && typeof this.root.root === 'string') {\n      this.root = this._root.root;\n    }\n    if ((data == null) && ((type != null ? type.data : void 0) != null) && ((type != null ? type.type : void 0) != null)) {\n      if (type instanceof Job) {\n        return type;\n      }\n      doc = type;\n      data = doc.data;\n      type = doc.type;\n    } else {\n      doc = {};\n    }\n    if (!(typeof doc === 'object' && typeof data === 'object' && typeof type === 'string' && typeof this.root === 'string')) {\n      throw new Error(\"new Job: bad parameter(s), \" + this.root + \" (\" + (typeof this.root) + \"), \" + type + \" (\" + (typeof type) + \"), \" + data + \" (\" + (typeof data) + \"), \" + doc + \" (\" + (typeof doc) + \")\");\n    } else if ((doc.type != null) && (doc.data != null)) {\n      this._doc = doc;\n    } else {\n      time = new Date();\n      this._doc = {\n        runId: null,\n        type: type,\n        data: data,\n        status: 'waiting',\n        updated: time,\n        created: time\n      };\n      this.priority().retry().repeat().after().progress().depends().log(\"Constructed\");\n    }\n    return this;\n  }\n\n  Job.prototype._echo = function(message, level) {\n    if (level == null) {\n      level = null;\n    }\n    switch (level) {\n      case 'danger':\n        console.error(message);\n        break;\n      case 'warning':\n        console.warn(message);\n        break;\n      case 'success':\n        console.log(message);\n        break;\n      default:\n        console.info(message);\n    }\n  };\n\n  Job.prototype.depends = function(jobs) {\n    var depends, j, k, len;\n    if (jobs) {\n      if (jobs instanceof Job) {\n        jobs = [jobs];\n      }\n      if (jobs instanceof Array) {\n        depends = this._doc.depends;\n        for (k = 0, len = jobs.length; k < len; k++) {\n          j = jobs[k];\n          if (!(j instanceof Job && (j._doc._id != null))) {\n            throw new Error('Each provided object must be a saved Job instance (with an _id)');\n          }\n          depends.push(j._doc._id);\n        }\n      } else {\n        throw new Error('Bad input parameter: depends() accepts a falsy value, or Job or array of Jobs');\n      }\n    } else {\n      depends = [];\n    }\n    this._doc.depends = depends;\n    this._doc.resolved = [];\n    return this;\n  };\n\n  Job.prototype.priority = function(level) {\n    var priority;\n    if (level == null) {\n      level = 0;\n    }\n    if (typeof level === 'string') {\n      priority = Job.jobPriorities[level];\n      if (priority == null) {\n        throw new Error('Invalid string priority level provided');\n      }\n    } else if (isInteger(level)) {\n      priority = level;\n    } else {\n      throw new Error('priority must be an integer or valid priority level');\n      priority = 0;\n    }\n    this._doc.priority = priority;\n    return this;\n  };\n\n  Job.prototype.retry = function(options) {\n    var base, ref;\n    if (options == null) {\n      options = 0;\n    }\n    if (isInteger(options) && options >= 0) {\n      options = {\n        retries: options\n      };\n    }\n    if (typeof options !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n    if (options.retries != null) {\n      if (!(isInteger(options.retries) && options.retries >= 0)) {\n        throw new Error('bad option: retries must be an integer >= 0');\n      }\n      options.retries++;\n    } else {\n      options.retries = Job.forever;\n    }\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n    if (options.backoff != null) {\n      if (ref = options.backoff, indexOf.call(Job.jobRetryBackoffMethods, ref) < 0) {\n        throw new Error('bad option: invalid retry backoff method');\n      }\n    } else {\n      options.backoff = 'constant';\n    }\n    this._doc.retries = options.retries;\n    this._doc.repeatRetries = options.retries;\n    this._doc.retryWait = options.wait;\n    if ((base = this._doc).retried == null) {\n      base.retried = 0;\n    }\n    this._doc.retryBackoff = options.backoff;\n    this._doc.retryUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.repeat = function(options) {\n    var base, ref;\n    if (options == null) {\n      options = 0;\n    }\n    if (isInteger(options) && options >= 0) {\n      options = {\n        repeats: options\n      };\n    }\n    if (typeof options !== 'object') {\n      throw new Error('bad parameter: accepts either an integer >= 0 or an options object');\n    }\n    if ((options.wait != null) && (options.schedule != null)) {\n      throw new Error('bad options: wait and schedule options are mutually exclusive');\n    }\n    if (options.repeats != null) {\n      if (!(isInteger(options.repeats) && options.repeats >= 0)) {\n        throw new Error('bad option: repeats must be an integer >= 0');\n      }\n    } else {\n      options.repeats = Job.forever;\n    }\n    if (options.until != null) {\n      if (!(options.until instanceof Date)) {\n        throw new Error('bad option: until must be a Date object');\n      }\n    } else {\n      options.until = Job.foreverDate;\n    }\n    if (options.wait != null) {\n      if (!(isInteger(options.wait) && options.wait >= 0)) {\n        throw new Error('bad option: wait must be an integer >= 0');\n      }\n    } else {\n      options.wait = 5 * 60 * 1000;\n    }\n    if (options.schedule != null) {\n      if (typeof options.schedule !== 'object') {\n        throw new Error('bad option, schedule option must be an object');\n      }\n      if (!((((ref = options.schedule) != null ? ref.schedules : void 0) != null) && options.schedule.schedules instanceof Array)) {\n        throw new Error('bad option, schedule object requires a schedules attribute of type Array.');\n      }\n      if ((options.schedule.exceptions != null) && !(options.schedule.exceptions instanceof Array)) {\n        throw new Error('bad option, schedule object exceptions attribute must be an Array');\n      }\n      options.wait = {\n        schedules: options.schedule.schedules,\n        exceptions: options.schedule.exceptions\n      };\n    }\n    this._doc.repeats = options.repeats;\n    this._doc.repeatWait = options.wait;\n    if ((base = this._doc).repeated == null) {\n      base.repeated = 0;\n    }\n    this._doc.repeatUntil = options.until;\n    return this;\n  };\n\n  Job.prototype.delay = function(wait) {\n    if (wait == null) {\n      wait = 0;\n    }\n    if (!(isInteger(wait) && wait >= 0)) {\n      throw new Error('Bad parameter, delay requires a non-negative integer.');\n    }\n    return this.after(new Date(new Date().valueOf() + wait));\n  };\n\n  Job.prototype.after = function(time) {\n    var after;\n    if (time == null) {\n      time = new Date(0);\n    }\n    if (typeof time === 'object' && time instanceof Date) {\n      after = time;\n    } else {\n      throw new Error('Bad parameter, after requires a valid Date object');\n    }\n    this._doc.after = after;\n    return this;\n  };\n\n  Job.prototype.log = function() {\n    var base, cb, k, message, options, ref, ref1;\n    message = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.level == null) {\n      options.level = 'info';\n    }\n    if (typeof message !== 'string') {\n      throw new Error('Log message must be a string');\n    }\n    if (!(typeof options.level === 'string' && (ref1 = options.level, indexOf.call(Job.jobLogLevels, ref1) >= 0))) {\n      throw new Error('Log level options must be one of Job.jobLogLevels');\n    }\n    if (options.echo != null) {\n      if (options.echo && Job.jobLogLevels.indexOf(options.level) >= Job.jobLogLevels.indexOf(options.echo)) {\n        this._echo(\"LOG: \" + options.level + \", \" + this._doc._id + \" \" + this._doc.runId + \": \" + message, options.level);\n      }\n      delete options.echo;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobLog\", [this._doc._id, this._doc.runId, message, options], cb);\n    } else {\n      if ((base = this._doc).log == null) {\n        base.log = [];\n      }\n      this._doc.log.push({\n        time: new Date(),\n        runId: null,\n        level: options.level,\n        message: message\n      });\n      if ((cb != null) && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n      return this;\n    }\n  };\n\n  Job.prototype.progress = function() {\n    var cb, completed, k, options, progress, ref, total;\n    completed = arguments[0], total = arguments[1], options = 4 <= arguments.length ? slice.call(arguments, 2, k = arguments.length - 1) : (k = 2, []), cb = arguments[k++];\n    if (completed == null) {\n      completed = 0;\n    }\n    if (total == null) {\n      total = 1;\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (typeof completed === 'number' && typeof total === 'number' && completed >= 0 && total > 0 && total >= completed) {\n      progress = {\n        completed: completed,\n        total: total,\n        percent: 100 * completed / total\n      };\n      if (options.echo) {\n        delete options.echo;\n        this._echo(\"PROGRESS: \" + this._doc._id + \" \" + this._doc.runId + \": \" + progress.completed + \" out of \" + progress.total + \" (\" + progress.percent + \"%)\");\n      }\n      if ((this._doc._id != null) && (this._doc.runId != null)) {\n        return methodCall(this._root, \"jobProgress\", [this._doc._id, this._doc.runId, completed, total, options], cb, (function(_this) {\n          return function(res) {\n            if (res) {\n              _this._doc.progress = progress;\n            }\n            return res;\n          };\n        })(this));\n      } else if (this._doc._id == null) {\n        this._doc.progress = progress;\n        if ((cb != null) && typeof cb === 'function') {\n          _setImmediate(cb, null, true);\n        }\n        return this;\n      }\n    } else {\n      throw new Error(\"job.progress: something is wrong with progress params: \" + this.id + \", \" + completed + \" out of \" + total);\n    }\n    return null;\n  };\n\n  Job.prototype.save = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    return methodCall(this._root, \"jobSave\", [this._doc, options], cb, (function(_this) {\n      return function(id) {\n        if (id) {\n          _this._doc._id = id;\n        }\n        return id;\n      };\n    })(this));\n  };\n\n  Job.prototype.refresh = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.getLog == null) {\n      options.getLog = false;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"getJob\", [this._doc._id, options], cb, (function(_this) {\n        return function(doc) {\n          if (doc != null) {\n            _this._doc = doc;\n            return _this;\n          } else {\n            return false;\n          }\n        };\n      })(this));\n    } else {\n      throw new Error(\"Can't call .refresh() on an unsaved job\");\n    }\n  };\n\n  Job.prototype.done = function() {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    if (result == null) {\n      result = {};\n    }\n    if (typeof result === 'function') {\n      cb = result;\n      result = {};\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (!((result != null) && typeof result === 'object')) {\n      result = {\n        value: result\n      };\n    }\n    if ((this._doc._id != null) && (this._doc.runId != null)) {\n      return methodCall(this._root, \"jobDone\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .done() on an unsaved or non-running job\");\n    }\n    return null;\n  };\n\n  Job.prototype.fail = function() {\n    var cb, k, options, ref, result;\n    result = arguments[0], options = 3 <= arguments.length ? slice.call(arguments, 1, k = arguments.length - 1) : (k = 1, []), cb = arguments[k++];\n    if (result == null) {\n      result = \"No error information provided\";\n    }\n    if (typeof result === 'function') {\n      cb = result;\n      result = \"No error information provided\";\n    }\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (!((result != null) && typeof result === 'object')) {\n      result = {\n        value: result\n      };\n    }\n    if (options.fatal == null) {\n      options.fatal = false;\n    }\n    if ((this._doc._id != null) && (this._doc.runId != null)) {\n      return methodCall(this._root, \"jobFail\", [this._doc._id, this._doc.runId, result, options], cb);\n    } else {\n      throw new Error(\"Can't call .fail() on an unsaved or non-running job\");\n    }\n    return null;\n  };\n\n  Job.prototype.pause = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobPause\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'paused';\n      if ((cb != null) && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n      return this;\n    }\n    return null;\n  };\n\n  Job.prototype.resume = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobResume\", [this._doc._id, options], cb);\n    } else {\n      this._doc.status = 'waiting';\n      if ((cb != null) && typeof cb === 'function') {\n        _setImmediate(cb, null, true);\n      }\n      return this;\n    }\n    return null;\n  };\n\n  Job.prototype.ready = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.force == null) {\n      options.force = false;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobReady\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .ready() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.cancel = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.antecedents == null) {\n      options.antecedents = true;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobCancel\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .cancel() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.restart = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.retries == null) {\n      options.retries = 1;\n    }\n    if (options.dependents == null) {\n      options.dependents = true;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRestart\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .restart() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.rerun = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (options.repeats == null) {\n      options.repeats = 0;\n    }\n    if (options.wait == null) {\n      options.wait = this._doc.repeatWait;\n    }\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRerun\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .rerun() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Job.prototype.remove = function() {\n    var cb, k, options, ref;\n    options = 2 <= arguments.length ? slice.call(arguments, 0, k = arguments.length - 1) : (k = 0, []), cb = arguments[k++];\n    ref = optionsHelp(options, cb), options = ref[0], cb = ref[1];\n    if (this._doc._id != null) {\n      return methodCall(this._root, \"jobRemove\", [this._doc._id, options], cb);\n    } else {\n      throw new Error(\"Can't call .remove() on an unsaved job\");\n    }\n    return null;\n  };\n\n  Object.defineProperties(Job.prototype, {\n    doc: {\n      get: function() {\n        return this._doc;\n      },\n      set: function() {\n        return console.warn(\"Job.doc cannot be directly assigned.\");\n      }\n    },\n    type: {\n      get: function() {\n        return this._doc.type;\n      },\n      set: function() {\n        return console.warn(\"Job.type cannot be directly assigned.\");\n      }\n    },\n    data: {\n      get: function() {\n        return this._doc.data;\n      },\n      set: function() {\n        return console.warn(\"Job.data cannot be directly assigned.\");\n      }\n    }\n  });\n\n  return Job;\n\n})();\n\nif ((typeof module !== \"undefined\" && module !== null ? module.exports : void 0) != null) {\n  module.exports = Job;\n}\n"]},"hash":"02e0d79344bf547532e568ad5556d6e875827ae9"}
