{"metadata":{"usedHelpers":["typeof","interopRequireDefault"],"marked":[],"modules":{"imports":[{"source":"meteor/jquery","imported":["$"],"specifiers":[{"kind":"named","imported":"$","local":"$"}]},{"source":"/client/api","imported":["Reaction"],"specifiers":[{"kind":"named","imported":"Reaction","local":"Reaction"}]},{"source":"/lib/api","imported":["ReactionProduct"],"specifiers":[{"kind":"named","imported":"ReactionProduct","local":"ReactionProduct"}]},{"source":"/lib/collections","imported":["Media"],"specifiers":[{"kind":"named","imported":"Media","local":"Media"}]},{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"meteor/session","imported":["Session"],"specifiers":[{"kind":"named","imported":"Session","local":"Session"}]},{"source":"meteor/templating","imported":["Template"],"specifiers":[{"kind":"named","imported":"Template","local":"Template"}]},{"source":"sortablejs","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Sortable"}]}],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js","filenameRelative":"/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js","inputSourceMap":{"version":3,"sources":["/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js"],"names":["$","Reaction","ReactionProduct","Media","Meteor","Session","Template","Sortable","uploadHandler","event","productId","selectedProductId","variant","selectedVariant","Alerts","add","autoHide","variantId","_id","shopId","selectedProduct","getShopId","userId","count","find","toGrid","ancestors","length","FS","Utility","eachFile","file","fileObj","File","metadata","ownerId","priority","insert","updateImagePriorities","toArray","map","element","index","mediaId","getAttribute","update","$set","productImageGallery","helpers","media","mediaArray","sort","onRendered","autorun","$gallery","hasAdminAccess","sortable","create","group","handle","onUpdate","events","stopImmediatePropagation","relatedTarget","undefined","hasPermission","first","target","instance","currentTarget","data","fadeOut","replaceWith","css","display","appendTo","fadeIn","imageUrl","closest","attr","alert","title","type","showCancelButton","imageHeight","isConfirm","remove","error","toast","reason","imageUploader","click","template","set"],"mappings":"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","file":"/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js.map","sourcesContent":["import { $ } from \"meteor/jquery\";\nimport { Reaction } from \"/client/api\";\nimport { ReactionProduct } from \"/lib/api\";\nimport { Media } from \"/lib/collections\";\nimport { Meteor } from \"meteor/meteor\";\nimport { Session } from \"meteor/session\";\nimport { Template } from \"meteor/templating\";\nimport Sortable from \"sortablejs\";\n\n/**\n * productImageGallery helpers\n */\n\n/*\n * uploadHandler method\n */\nfunction uploadHandler(event) {\n  // TODO: It would be cool to move this logic to common ValidatedMethod, but\n  // I can't find a way to do this, because of browser's `FileList` collection\n  // and it `Blob`s which is our event.target.files.\n  // There is a way to do this: http://stackoverflow.com/a/24003932. but it's too\n  // tricky\n  const productId = ReactionProduct.selectedProductId();\n  const variant = ReactionProduct.selectedVariant();\n  if (typeof variant !== \"object\") {\n    return Alerts.add(\"Please, create new Variant first.\", \"danger\", {\n      autoHide: true\n    });\n  }\n  const variantId = variant._id;\n  const shopId = ReactionProduct.selectedProduct().shopId || Reaction.getShopId();\n  const userId = Meteor.userId();\n  let count = Media.find({\n    \"metadata.variantId\": variantId\n  }).count();\n  // TODO: we need to mark the first variant images somehow for productGrid.\n  // But how do we know that this is the first, not second or other variant?\n  // Question is open. For now if product has more than 1 top variant, everyone\n  // will have a chance to be displayed\n  const toGrid = variant.ancestors.length === 1;\n\n  return FS.Utility.eachFile(event, function (file) {\n    const fileObj = new FS.File(file);\n    fileObj.metadata = {\n      ownerId: userId,\n      productId: productId,\n      variantId: variantId,\n      shopId: shopId,\n      priority: count,\n      toGrid: +toGrid // we need number\n    };\n    Media.insert(fileObj);\n    return count++;\n  });\n}\n\n/*\n * updateImagePriorities method\n */\nfunction updateImagePriorities() {\n  $(\".gallery > .gallery-image\")\n    .toArray()\n    .map((element, index) => {\n      const mediaId = element.getAttribute(\"data-index\");\n\n      Media.update(mediaId, {\n        $set: {\n          \"metadata.priority\": index\n        }\n      });\n    });\n}\n\n/**\n *  Product Image Gallery\n */\n\nTemplate.productImageGallery.helpers({\n  media: function () {\n    let mediaArray = [];\n    const variant = ReactionProduct.selectedVariant();\n\n    if (variant) {\n      mediaArray = Media.find({\n        \"metadata.variantId\": variant._id\n      }, {\n        sort: {\n          \"metadata.priority\": 1\n        }\n      });\n    }\n    return mediaArray;\n  },\n  variant: function () {\n    return ReactionProduct.selectedVariant();\n  }\n});\n\n/**\n * productImageGallery onRendered\n */\n\nTemplate.productImageGallery.onRendered(function () {\n  this.autorun(function () {\n    let $gallery;\n    if (Reaction.hasAdminAccess()) {\n      $gallery = $(\".gallery\")[0];\n\n      this.sortable = Sortable.create($gallery, {\n        group: \"gallery\",\n        handle: \".gallery-image\",\n        onUpdate() {\n          updateImagePriorities();\n        }\n      });\n    }\n  });\n});\n\n/*\n * productImageGallery events\n */\n\nTemplate.productImageGallery.events({\n  \"mouseenter .gallery > li\": function (event) {\n    event.stopImmediatePropagation();\n    // This is a workaround for an issue with FF refiring mouseover when the contents change\n    if (event.relatedTarget === null) {\n      return undefined;\n    }\n    if (!Reaction.hasPermission(\"createProduct\")) {\n      const first = $(\".gallery li:nth-child(1)\");\n      const target = Template.instance().$(event.currentTarget);\n      if ($(target).data(\"index\") !== first.data(\"index\")) {\n        return $(\".gallery li:nth-child(1)\").fadeOut(400, function () {\n          $(this).replaceWith(target);\n          first.css({\n            display: \"inline-block\"\n          }).appendTo($(\".gallery\"));\n          return $(\".gallery li:last-child\").fadeIn(100);\n        });\n      }\n    }\n    return undefined;\n  },\n  \"click .remove-image\": function () {\n    const imageUrl =\n      $(event.target)\n      .closest(\".gallery-image\")\n      .find(\"img\")\n      .attr(\"src\");\n\n    Alerts.alert({\n      title: \"Remove Media?\",\n      type: \"warning\",\n      showCancelButton: true,\n      imageUrl,\n      imageHeight: 150\n    }, (isConfirm) => {\n      if (isConfirm) {\n        const mediaId = this._id;\n\n        Media.remove({ _id: mediaId }, (error) => {\n          if (error) {\n            Alerts.toast(error.reason, \"warning\", {\n              autoHide: 10000\n            });\n          }\n\n          updateImagePriorities();\n        });\n      }\n    });\n  },\n  \"dropped #galleryDropPane\": uploadHandler\n});\n\n/*\n * imageUploader events\n */\n\nTemplate.imageUploader.events({\n  \"click #btn-upload\": function () {\n    return $(\"#files\").click();\n  },\n  \"change #files\": uploadHandler,\n  \"dropped #dropzone\": uploadHandler\n});\n\n/*\n * productImageGallery events\n */\n\nTemplate.productImageGallery.events({\n  \"click #img-upload\": function () {\n    return $(\"#files\").click();\n  },\n  \"load .img-responsive\": function (event, template) {\n    return Session.set(\"variantImgSrc\", template.$(\".img-responsive\").attr(\n      \"src\"));\n  }\n});\n"]},"env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js.map","sourceFileName":"/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"productImageGallery"},"ignored":false,"code":"var _typeof2 = require(\"babel-runtime/helpers/typeof\");\n\nvar _typeof3 = _interopRequireDefault(_typeof2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \"default\": obj }; }\n\nvar $ = void 0;\nmodule.importSync(\"meteor/jquery\", {\n  $: function (v) {\n    $ = v;\n  }\n}, 0);\nvar Reaction = void 0;\nmodule.importSync(\"/client/api\", {\n  Reaction: function (v) {\n    Reaction = v;\n  }\n}, 1);\nvar ReactionProduct = void 0;\nmodule.importSync(\"/lib/api\", {\n  ReactionProduct: function (v) {\n    ReactionProduct = v;\n  }\n}, 2);\nvar Media = void 0;\nmodule.importSync(\"/lib/collections\", {\n  Media: function (v) {\n    Media = v;\n  }\n}, 3);\nvar Meteor = void 0;\nmodule.importSync(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 4);\nvar Session = void 0;\nmodule.importSync(\"meteor/session\", {\n  Session: function (v) {\n    Session = v;\n  }\n}, 5);\nvar Template = void 0;\nmodule.importSync(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 6);\nvar Sortable = void 0;\nmodule.importSync(\"sortablejs\", {\n  \"default\": function (v) {\n    Sortable = v;\n  }\n}, 7);\n\n/**\n * productImageGallery helpers\n */ /*\n     * uploadHandler method\n     */function uploadHandler(event) {\n  // TODO: It would be cool to move this logic to common ValidatedMethod, but\n  // I can't find a way to do this, because of browser's `FileList` collection\n  // and it `Blob`s which is our event.target.files.\n  // There is a way to do this: http://stackoverflow.com/a/24003932. but it's too\n  // tricky\n  var productId = ReactionProduct.selectedProductId();\n  var variant = ReactionProduct.selectedVariant();\n\n  if ((typeof variant === \"undefined\" ? \"undefined\" : (0, _typeof3.default)(variant)) !== \"object\") {\n    return Alerts.add(\"Please, create new Variant first.\", \"danger\", {\n      autoHide: true\n    });\n  }\n\n  var variantId = variant._id;\n  var shopId = ReactionProduct.selectedProduct().shopId || Reaction.getShopId();\n  var userId = Meteor.userId();\n  var count = Media.find({\n    \"metadata.variantId\": variantId\n  }).count(); // TODO: we need to mark the first variant images somehow for productGrid.\n  // But how do we know that this is the first, not second or other variant?\n  // Question is open. For now if product has more than 1 top variant, everyone\n  // will have a chance to be displayed\n\n  var toGrid = variant.ancestors.length === 1;\n  return FS.Utility.eachFile(event, function (file) {\n    var fileObj = new FS.File(file);\n    fileObj.metadata = {\n      ownerId: userId,\n      productId: productId,\n      variantId: variantId,\n      shopId: shopId,\n      priority: count,\n      toGrid: +toGrid // we need number\n\n    };\n    Media.insert(fileObj);\n    return count++;\n  });\n} /*\n   * updateImagePriorities method\n   */\n\nfunction updateImagePriorities() {\n  $(\".gallery > .gallery-image\").toArray().map(function (element, index) {\n    var mediaId = element.getAttribute(\"data-index\");\n    Media.update(mediaId, {\n      $set: {\n        \"metadata.priority\": index\n      }\n    });\n  });\n} /**\n   *  Product Image Gallery\n   */\n\nTemplate.productImageGallery.helpers({\n  media: function () {\n    var mediaArray = [];\n    var variant = ReactionProduct.selectedVariant();\n\n    if (variant) {\n      mediaArray = Media.find({\n        \"metadata.variantId\": variant._id\n      }, {\n        sort: {\n          \"metadata.priority\": 1\n        }\n      });\n    }\n\n    return mediaArray;\n  },\n  variant: function () {\n    return ReactionProduct.selectedVariant();\n  }\n}); /**\n     * productImageGallery onRendered\n     */\nTemplate.productImageGallery.onRendered(function () {\n  this.autorun(function () {\n    var $gallery = void 0;\n\n    if (Reaction.hasAdminAccess()) {\n      $gallery = $(\".gallery\")[0];\n      this.sortable = Sortable.create($gallery, {\n        group: \"gallery\",\n        handle: \".gallery-image\",\n        onUpdate: function () {\n          updateImagePriorities();\n        }\n      });\n    }\n  });\n}); /*\n     * productImageGallery events\n     */\nTemplate.productImageGallery.events({\n  \"mouseenter .gallery > li\": function (event) {\n    event.stopImmediatePropagation(); // This is a workaround for an issue with FF refiring mouseover when the contents change\n\n    if (event.relatedTarget === null) {\n      return undefined;\n    }\n\n    if (!Reaction.hasPermission(\"createProduct\")) {\n      var first = $(\".gallery li:nth-child(1)\");\n      var target = Template.instance().$(event.currentTarget);\n\n      if ($(target).data(\"index\") !== first.data(\"index\")) {\n        return $(\".gallery li:nth-child(1)\").fadeOut(400, function () {\n          $(this).replaceWith(target);\n          first.css({\n            display: \"inline-block\"\n          }).appendTo($(\".gallery\"));\n          return $(\".gallery li:last-child\").fadeIn(100);\n        });\n      }\n    }\n\n    return undefined;\n  },\n  \"click .remove-image\": function () {\n    var _this = this;\n\n    var imageUrl = $(event.target).closest(\".gallery-image\").find(\"img\").attr(\"src\");\n    Alerts.alert({\n      title: \"Remove Media?\",\n      type: \"warning\",\n      showCancelButton: true,\n      imageUrl: imageUrl,\n      imageHeight: 150\n    }, function (isConfirm) {\n      if (isConfirm) {\n        var mediaId = _this._id;\n        Media.remove({\n          _id: mediaId\n        }, function (error) {\n          if (error) {\n            Alerts.toast(error.reason, \"warning\", {\n              autoHide: 10000\n            });\n          }\n\n          updateImagePriorities();\n        });\n      }\n    });\n  },\n  \"dropped #galleryDropPane\": uploadHandler\n}); /*\n     * imageUploader events\n     */\nTemplate.imageUploader.events({\n  \"click #btn-upload\": function () {\n    return $(\"#files\").click();\n  },\n  \"change #files\": uploadHandler,\n  \"dropped #dropzone\": uploadHandler\n}); /*\n     * productImageGallery events\n     */\nTemplate.productImageGallery.events({\n  \"click #img-upload\": function () {\n    return $(\"#files\").click();\n  },\n  \"load .img-responsive\": function (event, template) {\n    return Session.set(\"variantImgSrc\", template.$(\".img-responsive\").attr(\"src\"));\n  }\n});","map":{"version":3,"sources":["/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js"],"names":["$","Reaction","ReactionProduct","Media","Meteor","Session","Template","Sortable","uploadHandler","event","productId","selectedProductId","variant","selectedVariant","Alerts","add","autoHide","variantId","_id","shopId","selectedProduct","getShopId","userId","count","find","toGrid","ancestors","length","FS","Utility","eachFile","file","fileObj","File","metadata","ownerId","priority","insert","updateImagePriorities","toArray","map","element","index","mediaId","getAttribute","update","$set","productImageGallery","helpers","media","mediaArray","sort","onRendered","autorun","$gallery","hasAdminAccess","sortable","create","group","handle","onUpdate","events","stopImmediatePropagation","relatedTarget","undefined","hasPermission","first","target","instance","currentTarget","data","fadeOut","replaceWith","css","display","appendTo","fadeIn","imageUrl","closest","attr","alert","title","type","showCancelButton","imageHeight","isConfirm","remove","error","toast","reason","imageUploader","click","template","set"],"mappings":"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","file":"/imports/plugins/included/product-variant/client/templates/products/productDetail/productImageGallery.js.map","sourcesContent":["import { $ } from \"meteor/jquery\";\nimport { Reaction } from \"/client/api\";\nimport { ReactionProduct } from \"/lib/api\";\nimport { Media } from \"/lib/collections\";\nimport { Meteor } from \"meteor/meteor\";\nimport { Session } from \"meteor/session\";\nimport { Template } from \"meteor/templating\";\nimport Sortable from \"sortablejs\";\n\n/**\n * productImageGallery helpers\n */\n\n/*\n * uploadHandler method\n */\nfunction uploadHandler(event) {\n  // TODO: It would be cool to move this logic to common ValidatedMethod, but\n  // I can't find a way to do this, because of browser's `FileList` collection\n  // and it `Blob`s which is our event.target.files.\n  // There is a way to do this: http://stackoverflow.com/a/24003932. but it's too\n  // tricky\n  const productId = ReactionProduct.selectedProductId();\n  const variant = ReactionProduct.selectedVariant();\n  if (typeof variant !== \"object\") {\n    return Alerts.add(\"Please, create new Variant first.\", \"danger\", {\n      autoHide: true\n    });\n  }\n  const variantId = variant._id;\n  const shopId = ReactionProduct.selectedProduct().shopId || Reaction.getShopId();\n  const userId = Meteor.userId();\n  let count = Media.find({\n    \"metadata.variantId\": variantId\n  }).count();\n  // TODO: we need to mark the first variant images somehow for productGrid.\n  // But how do we know that this is the first, not second or other variant?\n  // Question is open. For now if product has more than 1 top variant, everyone\n  // will have a chance to be displayed\n  const toGrid = variant.ancestors.length === 1;\n\n  return FS.Utility.eachFile(event, function (file) {\n    const fileObj = new FS.File(file);\n    fileObj.metadata = {\n      ownerId: userId,\n      productId: productId,\n      variantId: variantId,\n      shopId: shopId,\n      priority: count,\n      toGrid: +toGrid // we need number\n    };\n    Media.insert(fileObj);\n    return count++;\n  });\n}\n\n/*\n * updateImagePriorities method\n */\nfunction updateImagePriorities() {\n  $(\".gallery > .gallery-image\")\n    .toArray()\n    .map((element, index) => {\n      const mediaId = element.getAttribute(\"data-index\");\n\n      Media.update(mediaId, {\n        $set: {\n          \"metadata.priority\": index\n        }\n      });\n    });\n}\n\n/**\n *  Product Image Gallery\n */\n\nTemplate.productImageGallery.helpers({\n  media: function () {\n    let mediaArray = [];\n    const variant = ReactionProduct.selectedVariant();\n\n    if (variant) {\n      mediaArray = Media.find({\n        \"metadata.variantId\": variant._id\n      }, {\n        sort: {\n          \"metadata.priority\": 1\n        }\n      });\n    }\n    return mediaArray;\n  },\n  variant: function () {\n    return ReactionProduct.selectedVariant();\n  }\n});\n\n/**\n * productImageGallery onRendered\n */\n\nTemplate.productImageGallery.onRendered(function () {\n  this.autorun(function () {\n    let $gallery;\n    if (Reaction.hasAdminAccess()) {\n      $gallery = $(\".gallery\")[0];\n\n      this.sortable = Sortable.create($gallery, {\n        group: \"gallery\",\n        handle: \".gallery-image\",\n        onUpdate() {\n          updateImagePriorities();\n        }\n      });\n    }\n  });\n});\n\n/*\n * productImageGallery events\n */\n\nTemplate.productImageGallery.events({\n  \"mouseenter .gallery > li\": function (event) {\n    event.stopImmediatePropagation();\n    // This is a workaround for an issue with FF refiring mouseover when the contents change\n    if (event.relatedTarget === null) {\n      return undefined;\n    }\n    if (!Reaction.hasPermission(\"createProduct\")) {\n      const first = $(\".gallery li:nth-child(1)\");\n      const target = Template.instance().$(event.currentTarget);\n      if ($(target).data(\"index\") !== first.data(\"index\")) {\n        return $(\".gallery li:nth-child(1)\").fadeOut(400, function () {\n          $(this).replaceWith(target);\n          first.css({\n            display: \"inline-block\"\n          }).appendTo($(\".gallery\"));\n          return $(\".gallery li:last-child\").fadeIn(100);\n        });\n      }\n    }\n    return undefined;\n  },\n  \"click .remove-image\": function () {\n    const imageUrl =\n      $(event.target)\n      .closest(\".gallery-image\")\n      .find(\"img\")\n      .attr(\"src\");\n\n    Alerts.alert({\n      title: \"Remove Media?\",\n      type: \"warning\",\n      showCancelButton: true,\n      imageUrl,\n      imageHeight: 150\n    }, (isConfirm) => {\n      if (isConfirm) {\n        const mediaId = this._id;\n\n        Media.remove({ _id: mediaId }, (error) => {\n          if (error) {\n            Alerts.toast(error.reason, \"warning\", {\n              autoHide: 10000\n            });\n          }\n\n          updateImagePriorities();\n        });\n      }\n    });\n  },\n  \"dropped #galleryDropPane\": uploadHandler\n});\n\n/*\n * imageUploader events\n */\n\nTemplate.imageUploader.events({\n  \"click #btn-upload\": function () {\n    return $(\"#files\").click();\n  },\n  \"change #files\": uploadHandler,\n  \"dropped #dropzone\": uploadHandler\n});\n\n/*\n * productImageGallery events\n */\n\nTemplate.productImageGallery.events({\n  \"click #img-upload\": function () {\n    return $(\"#files\").click();\n  },\n  \"load .img-responsive\": function (event, template) {\n    return Session.set(\"variantImgSrc\", template.$(\".img-responsive\").attr(\n      \"src\"));\n  }\n});\n"]},"hash":"c1724ee7c725ee91dd4f3df9bae86d5cfc70a1ea"}
